<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIXEL Auto Light - –¢–µ–º–Ω—ã–π –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–π</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e17;
            --bg-card: #151922;
            --neon-cyan: #00fff2;
            --neon-purple: #bf00ff;
            --text-primary: #e8e9ed;
            --text-secondary: #8b8e98;
            --accent: #00fff2;
        }

        body {
            font-family: 'Exo 2', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            background-image:
                radial-gradient(circle at 20% 30%, rgba(0, 255, 242, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(191, 0, 255, 0.05) 0%, transparent 50%);
        }

        .header {
            position: sticky;
            top: 0;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 255, 242, 0.2);
            padding: 16px 20px 18px;
            z-index: 100;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin: 0;
            animation: glow 2s ease-in-out infinite;
        }

        .brand-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 14px;
            flex-wrap: wrap;
        }

        .btn-profile {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 242, 0.3);
            background: rgba(0, 255, 242, 0.1);
            color: var(--neon-cyan);
            font-family: 'Exo 2', sans-serif;
            font-weight: 600;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-profile:hover {
            background: rgba(0, 255, 242, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 242, 0.1);
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 5px var(--neon-cyan)); }
            50% { filter: drop-shadow(0 0 15px var(--neon-cyan)); }
        }

        .search-bar {
            position: relative;
            margin-bottom: 14px;
        }

        .search-bar input {
            width: 100%;
            padding: 14px 50px 14px 20px;
            background: var(--bg-card);
            border: 1px solid rgba(0, 255, 242, 0.3);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: 'Exo 2', sans-serif;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 242, 0.2);
        }

        .search-bar input::placeholder {
            color: var(--text-secondary);
        }

        .search-icon {
            position: absolute;
            right: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neon-cyan);
            font-size: 20px;
        }

        .filter-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .top-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-family: 'Exo 2', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-secondary {
            background: rgba(0, 255, 242, 0.1);
            border: 1px solid rgba(0, 255, 242, 0.3);
            color: var(--neon-cyan);
        }

        .btn-cart {
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            color: var(--bg-dark);
            position: relative;
            overflow: hidden;
        }

        .btn-cart::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-cart:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-secondary:hover {
            background: rgba(0, 255, 242, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 242, 0.1);
        }

        .breadcrumb {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 0 20px 10px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .breadcrumb::-webkit-scrollbar {
            display: none;
        }

        .breadcrumb button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
        }

        .breadcrumb button:hover {
            color: var(--neon-cyan);
        }

        .breadcrumb-divider {
            color: rgba(0, 255, 242, 0.4);
        }

        .status-row {
            display: flex;
            gap: 8px;
            padding: 0 20px 16px;
            flex-wrap: wrap;
        }

        .status-pill {
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(0, 255, 242, 0.08);
            border: 1px solid rgba(0, 255, 242, 0.2);
            font-size: 12px;
            color: var(--text-secondary);
        }

        main {
            padding-bottom: 40px;
        }

        .products-grid {
            padding: 0 20px 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .product-card {
            background: var(--bg-card);
            border: 1px solid rgba(0, 255, 242, 0.15);
            border-radius: 16px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 242, 0.1), transparent);
            transition: left 0.5s;
        }

        .product-card:hover::before {
            left: 100%;
        }

        .product-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--neon-cyan);
            box-shadow: 0 10px 30px rgba(0, 255, 242, 0.2);
        }

        .product-card.disabled {
            opacity: 0.6;
            cursor: default;
        }

        .product-card.disabled:hover {
            transform: none;
            box-shadow: none;
            border-color: rgba(0, 255, 242, 0.15);
        }

        .product-image {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(135deg, rgba(0, 255, 242, 0.05), rgba(191, 0, 255, 0.05));
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 242, 0.1);
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-sku {
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            color: var(--neon-cyan);
            margin-bottom: 6px;
            font-weight: 700;
        }

        .product-name {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-weight: 400;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 255, 242, 0.1);
        }

        .product-price-block {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .product-price {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            font-weight: 900;
            color: var(--neon-cyan);
        }

        .product-price.muted {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .product-stock {
            font-size: 11px;
            color: var(--text-secondary);
            background: rgba(0, 255, 242, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .product-stock.low {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .add-to-cart {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: rgba(0, 255, 242, 0.1);
            border: 1px solid rgba(0, 255, 242, 0.3);
            border-radius: 8px;
            color: var(--neon-cyan);
            font-family: 'Exo 2', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        .add-to-cart:hover {
            background: var(--neon-cyan);
            color: var(--bg-dark);
            box-shadow: 0 5px 15px rgba(0, 255, 242, 0.3);
        }

        .add-to-cart:disabled {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .empty-state {
            display: none;
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .btn-load {
            width: calc(100% - 40px);
            margin: 0 20px 30px;
            background: rgba(0, 255, 242, 0.08);
            border: 1px solid rgba(0, 255, 242, 0.2);
            color: var(--neon-cyan);
        }

        .btn-load:hover {
            background: rgba(0, 255, 242, 0.2);
        }

        .drawer {
            position: fixed;
            inset: 0;
            background: rgba(5, 7, 12, 0.75);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 200;
            display: flex;
            align-items: flex-end;
        }

        .drawer.open {
            opacity: 1;
            pointer-events: auto;
        }

        .drawer-panel {
            width: 100%;
            max-height: 80vh;
            background: var(--bg-card);
            border-radius: 18px 18px 0 0;
            border: 1px solid rgba(0, 255, 242, 0.15);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.35s ease;
        }

        .drawer.open .drawer-panel {
            transform: translateY(0);
        }

        .drawer-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0, 255, 242, 0.1);
        }

        .drawer-header h3 {
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .drawer-body {
            padding: 14px 16px 20px;
            overflow-y: auto;
        }

        .drawer-footer {
            padding: 12px 20px 18px;
            border-top: 1px solid rgba(0, 255, 242, 0.1);
        }

        .profile-card {
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(0, 255, 242, 0.06);
            border: 1px solid rgba(0, 255, 242, 0.15);
            margin-bottom: 16px;
        }

        .profile-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .profile-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .profile-section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 242, 0.2);
            background: rgba(0, 255, 242, 0.1);
            color: var(--neon-cyan);
            cursor: pointer;
        }

        .category-item {
            display: flex;
            flex-direction: column;
        }

        .category-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 10px;
            margin: 3px 0;
            cursor: pointer;
            border: 1px solid transparent;
            background: rgba(0, 255, 242, 0.04);
            padding-left: calc(12px + (var(--level, 0) * 12px));
        }

        .category-row.active {
            border-color: var(--neon-cyan);
            background: rgba(0, 255, 242, 0.14);
            color: var(--neon-cyan);
        }

        .category-toggle {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 242, 0.2);
            background: rgba(0, 255, 242, 0.08);
            color: var(--neon-cyan);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-toggle:disabled {
            opacity: 0.2;
            cursor: default;
        }

        .category-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            padding: 12px;
            border-radius: 12px;
            background: rgba(0, 255, 242, 0.04);
            border: 1px solid rgba(0, 255, 242, 0.1);
            margin-bottom: 10px;
        }

        .cart-item-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cart-item-name {
            font-size: 13px;
            line-height: 1.3;
        }

        .cart-item-sku {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .qty-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 242, 0.2);
            background: rgba(0, 255, 242, 0.08);
            color: var(--neon-cyan);
            cursor: pointer;
        }

        .cart-item-price {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            color: var(--neon-cyan);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .order-card {
            padding: 12px;
            border-radius: 12px;
            background: rgba(0, 255, 242, 0.04);
            border: 1px solid rgba(0, 255, 242, 0.1);
            margin-bottom: 12px;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .order-status {
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(191, 0, 255, 0.12);
            color: var(--neon-purple);
            font-size: 11px;
        }

        .order-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 23, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .loading-card {
            padding: 16px 22px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid rgba(0, 255, 242, 0.2);
            color: var(--neon-cyan);
            font-size: 14px;
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 24px;
            transform: translate(-50%, 20px);
            padding: 10px 16px;
            border-radius: 999px;
            background: var(--bg-card);
            border: 1px solid rgba(0, 255, 242, 0.2);
            color: var(--text-primary);
            font-size: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 400;
        }

        .toast.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        @media (max-width: 720px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }

            .top-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 560px) {
            .brand-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .btn-profile {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="brand-row">
            <div class="logo">DIXEL</div>
            <button class="btn-profile" id="profileButton" type="button">–ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>

        <div class="search-bar">
            <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É, –Ω–∞–∑–≤–∞–Ω–∏—é...">
            <span class="search-icon">‚ö°</span>
        </div>

        <div class="filter-row">
            <button class="btn btn-secondary" id="openCategories" type="button">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
        </div>

        <div class="top-actions">
            <button class="btn btn-cart" id="cartButton" type="button">üõí –ö–æ—Ä–∑–∏–Ω–∞: 0 ‚ÇΩ</button>
        </div>
    </header>

    <div class="breadcrumb" id="breadcrumb"></div>
    <div class="status-row">
        <div class="status-pill" id="resultsCount">–¢–æ–≤–∞—Ä–æ–≤: 0</div>
        <div class="status-pill" id="activeFilters">–§–∏–ª—å—Ç—Ä—ã: –Ω–µ—Ç</div>
    </div>

    <main>
        <div class="products-grid" id="productsGrid"></div>
        <div class="empty-state" id="emptyState">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º.</div>
        <button class="btn btn-load" id="loadMoreButton" type="button">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ</button>
    </main>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-card">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–∞...</div>
    </div>

    <div class="drawer" id="categoryDrawer">
        <div class="drawer-panel">
            <div class="drawer-header">
                <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                <button class="icon-btn" data-close="categoryDrawer" type="button">‚úï</button>
            </div>
            <div class="drawer-body" id="categoryTree"></div>
        </div>
    </div>

    <div class="drawer" id="cartDrawer">
        <div class="drawer-panel">
            <div class="drawer-header">
                <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
                <button class="icon-btn" data-close="cartDrawer" type="button">‚úï</button>
            </div>
            <div class="drawer-body" id="cartItems"></div>
            <div class="drawer-footer">
                <div class="summary-row">
                    <span>–ò—Ç–æ–≥–æ</span>
                    <span id="cartTotal">0 ‚ÇΩ</span>
                </div>
                <button class="btn btn-cart" id="orderButton" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>
    </div>

    <div class="drawer" id="profileDrawer">
        <div class="drawer-panel">
            <div class="drawer-header">
                <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
                <button class="icon-btn" data-close="profileDrawer" type="button">‚úï</button>
            </div>
            <div class="drawer-body">
                <div class="profile-card">
                    <div class="profile-label">Telegram –∞–∫–∫–∞—É–Ω—Ç</div>
                    <div class="profile-value" id="profileTelegram">‚Äî</div>
                </div>
                <div class="profile-section-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
                <div id="profileHistory"></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <template id="productTemplate">
        <div class="product-card">
            <div class="product-image">
                <img src="" alt="">
            </div>
            <div class="product-sku"></div>
            <div class="product-name"></div>
            <div class="product-footer">
                <div class="product-price-block">
                    <div class="product-price"></div>
                </div>
                <div class="product-stock"></div>
            </div>
            <button class="add-to-cart" type="button">–í –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
    </template>

    <script>
        const PLACEHOLDER_IMAGE = "https://via.placeholder.com/200x200/151922/00fff2?text=DIXEL";

        const STORAGE_KEYS = {
            cart: "dixel_cart",
            orders: "dixel_orders",
            user: "dixel_user"
        };

        const state = {
            categoriesById: {},
            roots: [],
            categoryDescendants: {},
            expandedCategories: new Set(),
            selectedCategoryId: null,
            products: [],
            productsById: {},
            filteredProducts: [],
            searchQuery: "",
            pricesById: {},
            pricingEnabled: false,
            cart: [],
            orders: [],
            user: null,
            displayCount: 24
        };

        const el = {
            searchInput: document.getElementById("searchInput"),
            openCategories: document.getElementById("openCategories"),
            cartButton: document.getElementById("cartButton"),
            profileButton: document.getElementById("profileButton"),
            profileTelegram: document.getElementById("profileTelegram"),
            breadcrumb: document.getElementById("breadcrumb"),
            resultsCount: document.getElementById("resultsCount"),
            activeFilters: document.getElementById("activeFilters"),
            productsGrid: document.getElementById("productsGrid"),
            emptyState: document.getElementById("emptyState"),
            loadMoreButton: document.getElementById("loadMoreButton"),
            categoryDrawer: document.getElementById("categoryDrawer"),
            categoryTree: document.getElementById("categoryTree"),
            cartDrawer: document.getElementById("cartDrawer"),
            cartItems: document.getElementById("cartItems"),
            cartTotal: document.getElementById("cartTotal"),
            orderButton: document.getElementById("orderButton"),
            profileDrawer: document.getElementById("profileDrawer"),
            profileHistory: document.getElementById("profileHistory"),
            loadingOverlay: document.getElementById("loadingOverlay"),
            toast: document.getElementById("toast")
        };

        const productTemplate = document.getElementById("productTemplate");
        const currencyFormatter = new Intl.NumberFormat("ru-RU", { maximumFractionDigits: 0 });

        init();

        async function init() {
            bindUI();
            loadStoredState();
            initTelegram();
            renderProfile();
            await loadCatalog();
            renderCategoryTree();
            renderBreadcrumb();
            applyFilters();
            await fetchPricing();
            renderHistory();
            updateCartBadge();
        }

        function bindUI() {
            let searchTimer;
            el.searchInput.addEventListener("input", (event) => {
                clearTimeout(searchTimer);
                const value = event.target.value;
                searchTimer = setTimeout(() => {
                    state.searchQuery = value.trim().toLowerCase();
                    applyFilters();
                }, 150);
            });

            el.openCategories.addEventListener("click", () => openDrawer("categoryDrawer"));
            el.cartButton.addEventListener("click", () => {
                renderCart();
                openDrawer("cartDrawer");
            });
            el.profileButton.addEventListener("click", () => {
                renderProfile();
                renderHistory();
                openDrawer("profileDrawer");
            });
            el.orderButton.addEventListener("click", placeOrder);
            el.loadMoreButton.addEventListener("click", () => {
                state.displayCount += 24;
                renderProducts();
            });

            document.querySelectorAll(".drawer").forEach((drawer) => {
                drawer.addEventListener("click", (event) => {
                    if (event.target === drawer) {
                        closeDrawer(drawer.id);
                    }
                });
            });

            document.querySelectorAll("[data-close]").forEach((btn) => {
                btn.addEventListener("click", () => closeDrawer(btn.dataset.close));
            });
        }

        function loadStoredState() {
            state.cart = safeParse(localStorage.getItem(STORAGE_KEYS.cart), []);
            state.orders = safeParse(localStorage.getItem(STORAGE_KEYS.orders), []);
            const savedUser = safeParse(localStorage.getItem(STORAGE_KEYS.user), null);
            if (savedUser) {
                state.user = savedUser;
            }
            localStorage.removeItem("dixel_price_tier");
            state.pricingEnabled = false;
            state.pricesById = {};
        }

        function initTelegram() {
            const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            console.log("üîç [DEBUG] Telegram WebApp:", tg ? "–¥–æ—Å—Ç—É–ø–µ–Ω" : "–ù–ï –¥–æ—Å—Ç—É–ø–µ–Ω");
            if (tg) {
                tg.ready();
                tg.expand();
                console.log("üîç [DEBUG] initData:", tg.initData ? "–µ—Å—Ç—å" : "–ù–ï–¢");
            }
            const tgUser = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
            console.log("üîç [DEBUG] Telegram User:", tgUser);
            if (tgUser) {
                const fullName = [tgUser.first_name, tgUser.last_name].filter(Boolean).join(" ");
                state.user = {
                    id: tgUser.id,
                    name: fullName || tgUser.username || `ID ${tgUser.id}`,
                    username: tgUser.username || null
                };
                console.log("‚úÖ [DEBUG] User —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:", state.user);
                saveUser();
            }
        }

        function canShowPrices() {
            return state.pricingEnabled;
        }

        function renderProfile() {
            if (!el.profileTelegram) {
                return;
            }
            if (!state.user) {
                el.profileTelegram.textContent = "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
                return;
            }
            const handle = state.user.username ? `@${state.user.username}` : "";
            el.profileTelegram.textContent = handle || state.user.name || `ID ${state.user.id}`;
        }

        async function fetchPricing() {
            const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            const initData = tg ? tg.initData : "";
            console.log("üîç [DEBUG] fetchPricing - initData:", initData ? "–ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç" : "–û–¢–°–£–¢–°–¢–í–£–ï–¢");
            if (!initData) {
                console.warn("‚ö†Ô∏è [DEBUG] –ù–µ—Ç initData - —Ü–µ–Ω—ã –ù–ï –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã");
                state.pricingEnabled = false;
                state.pricesById = {};
                renderProducts();
                renderCart();
                updateCartBadge();
                return;
            }
            if (!state.products.length) {
                return;
            }

            try {
                console.log("üîç [DEBUG] –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ /api/pricing...");
                const response = await fetch("/api/pricing", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        initData,
                        productIds: state.products.map((product) => product.id)
                    })
                });
                if (!response.ok) {
                    throw new Error("Pricing fetch failed");
                }
                const payload = await response.json();
                console.log("üîç [DEBUG] –û—Ç–≤–µ—Ç /api/pricing:", payload);
                console.log("üîç [DEBUG] –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:", payload.authorized);
                state.pricingEnabled = Boolean(payload.authorized);
                const prices = payload.prices || {};
                const normalized = {};
                Object.keys(prices).forEach((key) => {
                    const value = Number.parseFloat(prices[key]);
                    if (Number.isFinite(value)) {
                        normalized[key] = value;
                    }
                });
                state.pricesById = normalized;
            } catch (error) {
                console.error(error);
                state.pricingEnabled = false;
                state.pricesById = {};
            }

            renderProducts();
            renderCart();
            updateCartBadge();
        }

        async function loadCatalog() {
            showLoading(true, "–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–π—Å–∞...");
            try {
                const response = await fetch("/api/catalog", { cache: "no-store" });
                if (!response.ok) {
                    throw new Error("Catalog fetch failed");
                }
                const payload = await response.json();
                applyCatalog(payload);
            } catch (error) {
                console.error(error);
                showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.");
            } finally {
                showLoading(false);
            }
        }

        function applyCatalog(payload) {
            const categories = Array.isArray(payload?.categories) ? payload.categories : [];
            const products = Array.isArray(payload?.products) ? payload.products : [];
            const categoriesById = {};
            categories.forEach((node) => {
                const id = node?.id ? String(node.id) : "";
                const parentId = node?.parentId ? String(node.parentId) : null;
                const name = node?.name ? String(node.name).trim() : "";
                if (!id || !name) {
                    return;
                }
                categoriesById[id] = {
                    id,
                    parentId: parentId || null,
                    name,
                    children: []
                };
            });

            const roots = [];
            Object.values(categoriesById).forEach((category) => {
                if (category.parentId && categoriesById[category.parentId]) {
                    categoriesById[category.parentId].children.push(category);
                } else {
                    roots.push(category);
                }
            });

            const sortCategories = (list) => {
                list.sort((a, b) => a.name.localeCompare(b.name, "ru"));
                list.forEach((item) => sortCategories(item.children));
            };
            sortCategories(roots);

            state.categoriesById = categoriesById;
            state.roots = roots;
            state.categoryDescendants = {};
            state.expandedCategories = new Set();
            const productsById = {};
            const normalized = products
                .map((item) => {
                    const id = item?.id ? String(item.id) : "";
                    const name = item?.name ? String(item.name).trim() : "";
                    if (!id || !name) {
                        return null;
                    }
                    const sku = item?.sku ? String(item.sku) : id;
                    const categoryId = item?.categoryId ? String(item.categoryId) : null;
                    const picture = item?.picture ? String(item.picture) : null;
                    const stockValue = Number.parseFloat(item?.stock);
                    const stock = Number.isFinite(stockValue) ? Math.round(stockValue) : 0;
                    const available = typeof item?.available === "boolean" ? item.available : stock > 0;

                    return {
                        id,
                        sku,
                        name,
                        categoryId,
                        picture,
                        available,
                        stock,
                        searchText: `${sku} ${name}`.toLowerCase()
                    };
                })
                .filter(Boolean)
                .filter((product) => product.stock > 0);

            normalized.forEach((product) => {
                productsById[product.id] = product;
            });

            state.products = normalized;
            state.productsById = productsById;
        }

        function renderBreadcrumb() {
            el.breadcrumb.innerHTML = "";
            const rootButton = document.createElement("button");
            rootButton.textContent = "–í—Å–µ —Ç–æ–≤–∞—Ä—ã";
            rootButton.addEventListener("click", () => selectCategory(null));
            el.breadcrumb.appendChild(rootButton);

            if (!state.selectedCategoryId) {
                return;
            }

            const path = getCategoryPath(state.selectedCategoryId);
            path.forEach((category) => {
                const divider = document.createElement("span");
                divider.className = "breadcrumb-divider";
                divider.textContent = "‚Ä∫";
                const button = document.createElement("button");
                button.textContent = category.name;
                button.addEventListener("click", () => selectCategory(category.id));
                el.breadcrumb.appendChild(divider);
                el.breadcrumb.appendChild(button);
            });
        }

        function renderCategoryTree() {
            el.categoryTree.innerHTML = "";
            const fragment = document.createDocumentFragment();

            const allWrapper = document.createElement("div");
            allWrapper.className = "category-item";
            const allRow = document.createElement("div");
            allRow.className = `category-row${!state.selectedCategoryId ? " active" : ""}`;
            allRow.style.setProperty("--level", 0);
            const allToggle = document.createElement("button");
            allToggle.className = "category-toggle";
            allToggle.disabled = true;
            const allName = document.createElement("div");
            allName.className = "category-name";
            allName.textContent = "–í—Å–µ —Ç–æ–≤–∞—Ä—ã";
            allRow.appendChild(allToggle);
            allRow.appendChild(allName);
            allRow.addEventListener("click", () => {
                selectCategory(null);
                closeDrawer("categoryDrawer");
            });
            allWrapper.appendChild(allRow);
            fragment.appendChild(allWrapper);

            state.roots.forEach((category) => {
                fragment.appendChild(renderCategoryItem(category, 0));
            });

            el.categoryTree.appendChild(fragment);
        }

        function renderCategoryItem(category, level) {
            const wrapper = document.createElement("div");
            wrapper.className = "category-item";

            const row = document.createElement("div");
            row.className = `category-row${category.id === state.selectedCategoryId ? " active" : ""}`;
            row.style.setProperty("--level", level);

            const toggle = document.createElement("button");
            toggle.className = "category-toggle";
            if (category.children.length) {
                toggle.textContent = state.expandedCategories.has(category.id) ? "‚àí" : "+";
            } else {
                toggle.textContent = "";
                toggle.disabled = true;
            }

            toggle.addEventListener("click", (event) => {
                event.stopPropagation();
                if (!category.children.length) {
                    return;
                }
                if (state.expandedCategories.has(category.id)) {
                    state.expandedCategories.delete(category.id);
                } else {
                    state.expandedCategories.add(category.id);
                }
                renderCategoryTree();
            });

            const name = document.createElement("div");
            name.className = "category-name";
            name.textContent = category.name;

            row.appendChild(toggle);
            row.appendChild(name);

            row.addEventListener("click", () => {
                selectCategory(category.id);
                closeDrawer("categoryDrawer");
            });

            wrapper.appendChild(row);

            if (category.children.length && state.expandedCategories.has(category.id)) {
                const childrenWrapper = document.createElement("div");
                childrenWrapper.className = "category-children";
                category.children.forEach((child) => {
                    childrenWrapper.appendChild(renderCategoryItem(child, level + 1));
                });
                wrapper.appendChild(childrenWrapper);
            }

            return wrapper;
        }

        function applyFilters() {
            const query = state.searchQuery.trim().toLowerCase();
            const categorySet = state.selectedCategoryId ? getCategorySet(state.selectedCategoryId) : null;

            state.filteredProducts = state.products.filter((product) => {
                if (query && !product.searchText.includes(query)) {
                    return false;
                }
                if (categorySet && !categorySet.has(product.categoryId)) {
                    return false;
                }
                return true;
            });

            state.displayCount = 24;
            updateStatus();
            renderProducts();
        }

        function renderProducts() {
            el.productsGrid.innerHTML = "";
            const fragment = document.createDocumentFragment();
            const visible = state.filteredProducts.slice(0, state.displayCount);
            visible.forEach((product) => {
                fragment.appendChild(renderProductCard(product));
            });
            el.productsGrid.appendChild(fragment);

            el.emptyState.style.display = visible.length ? "none" : "block";
            el.loadMoreButton.style.display = state.filteredProducts.length > state.displayCount ? "block" : "none";
        }

        function renderProductCard(product) {
            const card = productTemplate.content.firstElementChild.cloneNode(true);
            const img = card.querySelector(".product-image img");
            img.src = product.picture || PLACEHOLDER_IMAGE;
            img.alt = product.name;

            card.querySelector(".product-sku").textContent = product.sku;
            card.querySelector(".product-name").textContent = product.name;

            const priceEl = card.querySelector(".product-price");
            const pricesVisible = canShowPrices();
            const priceValue = pricesVisible ? getProductPrice(product.id) : null;
            const showPrice = pricesVisible && Number.isFinite(priceValue);
            priceEl.textContent = showPrice ? formatPrice(priceValue) : "‚Äî";
            priceEl.classList.toggle("muted", !showPrice);

            const stock = card.querySelector(".product-stock");
            const addButton = card.querySelector(".add-to-cart");
            if (!showPrice) {
                addButton.disabled = true;
            }
            if (!product.available || product.stock <= 0) {
                stock.textContent = "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏";
                stock.classList.add("low");
                addButton.disabled = true;
                card.classList.add("disabled");
            } else {
                stock.textContent = `${product.stock} —à—Ç`;
                if (product.stock <= 2) {
                    stock.classList.add("low");
                }
            }

            addButton.addEventListener("click", (event) => {
                event.stopPropagation();
                addToCart(product.id);
            });

            return card;
        }

        function selectCategory(categoryId) {
            state.selectedCategoryId = categoryId;
            if (categoryId) {
                expandCategoryPath(categoryId);
            }
            renderBreadcrumb();
            renderCategoryTree();
            applyFilters();
        }

        function expandCategoryPath(categoryId) {
            let current = state.categoriesById[categoryId];
            while (current) {
                state.expandedCategories.add(current.id);
                current = current.parentId ? state.categoriesById[current.parentId] : null;
            }
        }

        function getCategorySet(categoryId) {
            if (!categoryId) {
                return null;
            }
            if (state.categoryDescendants[categoryId]) {
                return state.categoryDescendants[categoryId];
            }
            const set = new Set();
            const stack = [categoryId];
            while (stack.length) {
                const currentId = stack.pop();
                if (!currentId || set.has(currentId)) {
                    continue;
                }
                set.add(currentId);
                const children = state.categoriesById[currentId]?.children || [];
                children.forEach((child) => stack.push(child.id));
            }
            state.categoryDescendants[categoryId] = set;
            return set;
        }

        function getCategoryPath(categoryId) {
            const path = [];
            let current = state.categoriesById[categoryId];
            while (current) {
                path.unshift(current);
                current = current.parentId ? state.categoriesById[current.parentId] : null;
            }
            return path;
        }

        function updateStatus() {
            el.resultsCount.textContent = `–¢–æ–≤–∞—Ä–æ–≤: ${state.filteredProducts.length}`;
            const filters = [];
            if (state.selectedCategoryId) {
                const path = getCategoryPath(state.selectedCategoryId);
                if (path.length) {
                    filters.push(`–∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${shorten(path[path.length - 1].name, 24)}`);
                }
            }
            if (state.searchQuery) {
                filters.push(`–ø–æ–∏—Å–∫: ${shorten(state.searchQuery, 24)}`);
            }
            el.activeFilters.textContent = filters.length ? `–§–∏–ª—å—Ç—Ä—ã: ${filters.join(", ")}` : "–§–∏–ª—å—Ç—Ä—ã: –Ω–µ—Ç";
        }

        function addToCart(productId) {
            if (!canShowPrices()) {
                showToast("–¶–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
                return;
            }
            const product = state.productsById[productId];
            if (!product || !product.available || product.stock <= 0) {
                return;
            }
            if (!Number.isFinite(getProductPrice(product.id))) {
                showToast("–¶–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
                return;
            }
            const existing = state.cart.find((item) => item.productId === productId);
            if (existing) {
                existing.qty += 1;
            } else {
                state.cart.push({ productId, qty: 1 });
            }
            saveCart();
            updateCartBadge();
            showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
        }

        function renderCart() {
            el.cartItems.innerHTML = "";
            if (!canShowPrices()) {
                el.cartItems.innerHTML = '<div class="empty-state" style="display:block">–¶–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.</div>';
                el.cartTotal.textContent = formatPrice(null);
                return;
            }
            if (!state.cart.length) {
                el.cartItems.innerHTML = '<div class="empty-state" style="display:block">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</div>';
                el.cartTotal.textContent = formatPrice(0);
                return;
            }

            const fragment = document.createDocumentFragment();
            state.cart.forEach((item) => {
                const product = state.productsById[item.productId];
                if (!product) {
                    return;
                }

                const row = document.createElement("div");
                row.className = "cart-item";

                const info = document.createElement("div");
                info.className = "cart-item-info";
                const name = document.createElement("div");
                name.className = "cart-item-name";
                name.textContent = product.name;
                const sku = document.createElement("div");
                sku.className = "cart-item-sku";
                sku.textContent = product.sku;
                info.appendChild(name);
                info.appendChild(sku);

                const controls = document.createElement("div");
                controls.className = "cart-item-controls";
                const minus = document.createElement("button");
                minus.className = "qty-btn";
                minus.type = "button";
                minus.textContent = "‚àí";
                const qty = document.createElement("span");
                qty.textContent = item.qty;
                const plus = document.createElement("button");
                plus.className = "qty-btn";
                plus.type = "button";
                plus.textContent = "+";

                minus.addEventListener("click", () => updateCartQty(item.productId, item.qty - 1));
                plus.addEventListener("click", () => updateCartQty(item.productId, item.qty + 1));

                controls.appendChild(minus);
                controls.appendChild(qty);
                controls.appendChild(plus);

                const price = document.createElement("div");
                price.className = "cart-item-price";
                const unitPrice = getProductPrice(product.id);
                const lineTotal = Number.isFinite(unitPrice) ? unitPrice * item.qty : null;
                price.textContent = formatPrice(lineTotal);

                row.appendChild(info);
                row.appendChild(controls);
                row.appendChild(price);

                fragment.appendChild(row);
            });

            el.cartItems.appendChild(fragment);
            el.cartTotal.textContent = formatPrice(calculateCartTotal());
        }

        function updateCartQty(productId, qty) {
            const item = state.cart.find((entry) => entry.productId === productId);
            if (!item) {
                return;
            }
            if (qty <= 0) {
                state.cart = state.cart.filter((entry) => entry.productId !== productId);
            } else {
                item.qty = qty;
            }
            saveCart();
            renderCart();
            updateCartBadge();
        }

        function calculateCartTotal() {
            if (!canShowPrices()) {
                return null;
            }
            return state.cart.reduce((sum, item) => {
                const product = state.productsById[item.productId];
                if (!product) {
                    return sum;
                }
                const price = getProductPrice(product.id);
                if (!Number.isFinite(price)) {
                    return sum;
                }
                return sum + price * item.qty;
            }, 0);
        }

        function updateCartBadge() {
            const total = calculateCartTotal();
            el.cartButton.textContent = `üõí –ö–æ—Ä–∑–∏–Ω–∞: ${formatPrice(total)}`;
        }

        function placeOrder() {
            if (!canShowPrices()) {
                showToast("–¶–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
                return;
            }
            if (!state.user || !state.user.id) {
                showToast("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");
                return;
            }
            if (!state.cart.length) {
                showToast("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");
                return;
            }

            const orderId = createOrderId();
            const createdAt = new Date().toISOString();
            const total = calculateCartTotal();
            if (!Number.isFinite(total)) {
                showToast("–¶–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
                return;
            }
            const items = state.cart.map((item) => {
                const product = state.productsById[item.productId];
                return {
                    productId: item.productId,
                    sku: product?.sku,
                    name: product?.name,
                    qty: item.qty,
                    price: getProductPrice(product?.id)
                };
            });

            const order = {
                id: orderId,
                createdAt,
                status: "–í –æ–±—Ä–∞–±–æ—Ç–∫–µ",
                total,
                items,
                userId: state.user ? state.user.id : null
            };

            state.orders.unshift(order);
            saveOrders();
            sendOrderToTelegram(order);

            state.cart = [];
            saveCart();
            renderCart();
            renderHistory();
            updateCartBadge();
            closeDrawer("cartDrawer");
            showToast("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω");
        }

        function renderHistory() {
            el.profileHistory.innerHTML = "";
            const currentUserId = state.user ? String(state.user.id) : null;
            const orders = currentUserId
                ? state.orders.filter((order) => {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–∫–∞–∑—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è + –∑–∞–∫–∞–∑—ã –±–µ–∑ userId (—Å–æ–∑–¥–∞–Ω—ã –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
                    if (order.userId === null || order.userId === undefined) {
                        return true;
                    }
                    return String(order.userId) === currentUserId;
                })
                : [];
            if (!orders.length) {
                el.profileHistory.innerHTML = '<div class="empty-state" style="display:block">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>';
                return;
            }

            const fragment = document.createDocumentFragment();
            orders.forEach((order) => {
                const card = document.createElement("div");
                card.className = "order-card";

                const header = document.createElement("div");
                header.className = "order-header";
                const title = document.createElement("div");
                title.textContent = `–ó–∞–∫–∞–∑ ${order.id}`;
                const status = document.createElement("span");
                status.className = "order-status";
                status.textContent = order.status || "–í –æ–±—Ä–∞–±–æ—Ç–∫–µ";
                header.appendChild(title);
                header.appendChild(status);

                const meta = document.createElement("div");
                meta.className = "order-meta";
                const date = new Date(order.createdAt).toLocaleString("ru-RU");
                const itemsCount = order.items.reduce((sum, item) => sum + (item.qty || 0), 0);
                meta.textContent = `${date} ‚Ä¢ ${itemsCount} –ø–æ–∑–∏—Ü–∏–π ‚Ä¢ ${formatPrice(order.total)}`;

                card.appendChild(header);
                card.appendChild(meta);
                fragment.appendChild(card);
            });

            el.profileHistory.appendChild(fragment);
        }

        function sendOrderToTelegram(order) {
            const payload = {
                type: "order",
                orderId: order.id,
                createdAt: order.createdAt,
                total: order.total,
                user: state.user,
                items: order.items
            };

            const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            if (tg && tg.sendData) {
                tg.sendData(JSON.stringify(payload));
            } else {
                console.log("Telegram payload", payload);
            }
        }

        function openDrawer(id) {
            const drawer = document.getElementById(id);
            if (drawer) {
                drawer.classList.add("open");
            }
        }

        function closeDrawer(id) {
            const drawer = document.getElementById(id);
            if (drawer) {
                drawer.classList.remove("open");
            }
        }

        function showLoading(isVisible, text) {
            if (text) {
                const label = el.loadingOverlay.querySelector(".loading-card");
                label.textContent = text;
            }
            el.loadingOverlay.style.display = isVisible ? "flex" : "none";
        }

        function showToast(message) {
            if (!message) {
                return;
            }
            el.toast.textContent = message;
            el.toast.classList.add("show");
            clearTimeout(el.toast._timer);
            el.toast._timer = setTimeout(() => {
                el.toast.classList.remove("show");
            }, 2600);
        }

        function formatPrice(value) {
            if (!Number.isFinite(value)) {
                return "‚Äî";
            }
            return `${currencyFormatter.format(value)} ‚ÇΩ`;
        }

        function getProductPrice(productId) {
            const value = state.pricesById[productId];
            return Number.isFinite(value) ? value : null;
        }

        function createOrderId() {
            const stamp = new Date().toISOString().replace(/[-:T]/g, "").slice(0, 12);
            const rnd = Math.floor(Math.random() * 90 + 10);
            return `DX-${stamp}-${rnd}`;
        }


        function saveCart() {
            localStorage.setItem(STORAGE_KEYS.cart, JSON.stringify(state.cart));
        }

        function saveOrders() {
            localStorage.setItem(STORAGE_KEYS.orders, JSON.stringify(state.orders));
        }

        function saveUser() {
            localStorage.setItem(STORAGE_KEYS.user, JSON.stringify(state.user));
        }

        function safeParse(raw, fallback) {
            if (!raw) {
                return fallback;
            }
            try {
                return JSON.parse(raw) ?? fallback;
            } catch (error) {
                return fallback;
            }
        }

        function shorten(text, maxLength) {
            if (!text || text.length <= maxLength) {
                return text;
            }
            return `${text.slice(0, maxLength)}...`;
        }
    </script>
</body>
</html>
