<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIXEL Auto Light - –¢–µ–º–Ω—ã–π –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–π</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0e17;
            --bg-card: #151922;
            --neon-cyan: #00fff2;
            --neon-purple: #bf00ff;
            --text-primary: #e8e9ed;
            --text-secondary: #8b8e98;
            --accent: #00fff2;
        }

        body {
            font-family: 'Exo 2', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            background-image:
                radial-gradient(circle at 20% 30%, rgba(0, 255, 242, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(191, 0, 255, 0.05) 0%, transparent 50%);
        }

        .header {
            position: sticky;
            top: 0;
            background: rgba(10, 14, 23, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 255, 242, 0.2);
            padding: 12px 14px 14px;
            z-index: 100;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin: 0;
            animation: glow 2s ease-in-out infinite;
        }

        .brand-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 242, 0.3);
            background: rgba(0, 255, 242, 0.1);
            color: var(--neon-cyan);
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .header-action-btn:hover {
            background: rgba(0, 255, 242, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 242, 0.1);
        }

        .header-cart-btn {
            background: linear-gradient(135deg, rgba(0, 255, 242, 0.2), rgba(191, 0, 255, 0.2));
        }

        .header-cart-count {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            border-radius: 999px;
            padding: 0 4px;
            background: #ff6b6b;
            color: #fff;
            font-size: 10px;
            line-height: 18px;
            font-weight: 700;
            display: none;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(10, 14, 23, 0.8);
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 5px var(--neon-cyan)); }
            50% { filter: drop-shadow(0 0 15px var(--neon-cyan)); }
        }

        .search-row {
            display: flex;
            align-items: stretch;
            gap: 10px;
        }

        .search-bar {
            position: relative;
            flex: 1;
        }

        .search-bar input {
            width: 100%;
            height: 44px;
            padding: 12px 44px 12px 14px;
            background: var(--bg-card);
            border: 1px solid rgba(0, 255, 242, 0.3);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 15px;
            font-family: 'Exo 2', sans-serif;
            transition: all 0.3s ease;
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--neon-cyan);
            box-shadow: 0 0 20px rgba(0, 255, 242, 0.2);
        }

        .search-bar input::placeholder {
            color: var(--text-secondary);
        }

        .search-icon {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--neon-cyan);
            font-size: 18px;
        }

        .btn-categories {
            height: 44px;
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 242, 0.3);
            background: rgba(0, 255, 242, 0.1);
            color: var(--neon-cyan);
            font-family: 'Exo 2', sans-serif;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 0 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .btn-categories:hover {
            background: rgba(0, 255, 242, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 242, 0.1);
        }

        .btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            font-family: 'Exo 2', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-secondary {
            background: rgba(0, 255, 242, 0.1);
            border: 1px solid rgba(0, 255, 242, 0.3);
            color: var(--neon-cyan);
        }

        .btn-cart {
            background: linear-gradient(135deg, var(--neon-cyan), var(--neon-purple));
            color: var(--bg-dark);
            position: relative;
            overflow: hidden;
        }

        .btn-cart::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-cart:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-secondary:hover {
            background: rgba(0, 255, 242, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 242, 0.1);
        }

        .breadcrumb {
            display: flex;
            gap: 6px;
            align-items: center;
            padding: 0 20px 10px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .breadcrumb::-webkit-scrollbar {
            display: none;
        }

        .breadcrumb button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
        }

        .breadcrumb button:hover {
            color: var(--neon-cyan);
        }

        .breadcrumb-divider {
            color: rgba(0, 255, 242, 0.4);
        }

        .status-row {
            display: flex;
            gap: 8px;
            padding: 0 20px 16px;
            flex-wrap: wrap;
        }

        .status-pill {
            padding: 6px 12px;
            border-radius: 999px;
            background: rgba(0, 255, 242, 0.08);
            border: 1px solid rgba(0, 255, 242, 0.2);
            font-size: 12px;
            color: var(--text-secondary);
        }

        main {
            padding-bottom: 40px;
        }

        .products-grid {
            padding: 0 20px 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .product-card {
            background: var(--bg-card);
            border: 1px solid rgba(0, 255, 242, 0.15);
            border-radius: 16px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 242, 0.1), transparent);
            transition: left 0.5s;
        }

        .product-card:hover::before {
            left: 100%;
        }

        .product-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--neon-cyan);
            box-shadow: 0 10px 30px rgba(0, 255, 242, 0.2);
        }

        .product-card.disabled {
            opacity: 0.6;
            cursor: default;
        }

        .product-card.disabled:hover {
            transform: none;
            box-shadow: none;
            border-color: rgba(0, 255, 242, 0.15);
        }

        .product-image {
            width: 100%;
            aspect-ratio: 1;
            background: linear-gradient(135deg, rgba(0, 255, 242, 0.05), rgba(191, 0, 255, 0.05));
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 242, 0.1);
            position: relative;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.2s ease;
        }

        .product-image.is-placeholder {
            background:
                radial-gradient(120% 120% at 0% 0%, rgba(0, 255, 242, 0.18), rgba(21, 25, 34, 0.95) 55%),
                linear-gradient(135deg, rgba(191, 0, 255, 0.08), rgba(0, 255, 242, 0.08));
            border-color: rgba(0, 255, 242, 0.2);
        }

        .product-image.is-placeholder::before {
            content: "";
            position: absolute;
            inset: 16%;
            border-radius: 18px;
            border: 1px dashed rgba(0, 255, 242, 0.35);
            box-shadow: 0 0 16px rgba(0, 255, 242, 0.18);
        }

        .product-image.is-placeholder::after {
            content: "–ù–µ—Ç —Ñ–æ—Ç–æ";
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            letter-spacing: 0.25em;
            color: rgba(0, 255, 242, 0.75);
            text-transform: uppercase;
            text-shadow: 0 0 12px rgba(0, 255, 242, 0.35);
        }

        .product-image.is-placeholder img {
            opacity: 0;
        }

        .product-sku {
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            color: var(--neon-cyan);
            margin-bottom: 6px;
            font-weight: 700;
        }

        .product-name {
            font-size: 13px;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-weight: 400;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 255, 242, 0.1);
        }

        .product-price-block {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .product-price {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            font-weight: 900;
            color: var(--neon-cyan);
        }

        .product-price.muted {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .product-stock {
            font-size: 11px;
            color: var(--text-secondary);
            background: rgba(0, 255, 242, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .product-stock.low {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .add-to-cart {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: rgba(0, 255, 242, 0.1);
            border: 1px solid rgba(0, 255, 242, 0.3);
            border-radius: 8px;
            color: var(--neon-cyan);
            font-family: 'Exo 2', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        .add-to-cart:hover {
            background: var(--neon-cyan);
            color: var(--bg-dark);
            box-shadow: 0 5px 15px rgba(0, 255, 242, 0.3);
        }

        .add-to-cart:disabled {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .empty-state {
            display: none;
            text-align: center;
            padding: 30px 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .btn-load {
            width: calc(100% - 40px);
            margin: 0 20px 30px;
            background: rgba(0, 255, 242, 0.08);
            border: 1px solid rgba(0, 255, 242, 0.2);
            color: var(--neon-cyan);
        }

        .btn-load:hover {
            background: rgba(0, 255, 242, 0.2);
        }

        .drawer {
            position: fixed;
            inset: 0;
            background: rgba(5, 7, 12, 0.75);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 200;
            display: flex;
            align-items: flex-end;
        }

        .drawer.open {
            opacity: 1;
            pointer-events: auto;
        }

        .drawer-panel {
            width: 100%;
            max-height: 80vh;
            background: var(--bg-card);
            border-radius: 18px 18px 0 0;
            border: 1px solid rgba(0, 255, 242, 0.15);
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.35s ease;
        }

        .drawer.open .drawer-panel {
            transform: translateY(0);
        }

        .drawer.drawer-left {
            align-items: stretch;
            justify-content: flex-start;
        }

        .drawer.drawer-left .drawer-panel {
            width: min(84vw, 340px);
            max-height: 100vh;
            border-radius: 0 18px 18px 0;
            transform: translateX(-100%);
        }

        .drawer.drawer-left.open .drawer-panel {
            transform: translateX(0);
        }

        .drawer-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0, 255, 242, 0.1);
        }

        .drawer-header h3 {
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .drawer-body {
            padding: 14px 16px 20px;
            overflow-y: auto;
        }

        .drawer-footer {
            padding: 12px 20px 18px;
            border-top: 1px solid rgba(0, 255, 242, 0.1);
        }

        .profile-card {
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(0, 255, 242, 0.06);
            border: 1px solid rgba(0, 255, 242, 0.15);
            margin-bottom: 16px;
        }

        .profile-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .profile-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .profile-section-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 242, 0.2);
            background: rgba(0, 255, 242, 0.1);
            color: var(--neon-cyan);
            cursor: pointer;
        }

        .category-item {
            display: flex;
            flex-direction: column;
        }

        .category-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 10px;
            margin: 3px 0;
            cursor: pointer;
            border: 1px solid transparent;
            background: rgba(0, 255, 242, 0.04);
            padding-left: calc(12px + (var(--level, 0) * 12px));
        }

        .category-row.active {
            border-color: var(--neon-cyan);
            background: rgba(0, 255, 242, 0.14);
            color: var(--neon-cyan);
        }

        .category-toggle {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 242, 0.2);
            background: rgba(0, 255, 242, 0.08);
            color: var(--neon-cyan);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-toggle:disabled {
            opacity: 0.2;
            cursor: default;
        }

        .category-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 13px;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            padding: 12px;
            border-radius: 12px;
            background: rgba(0, 255, 242, 0.04);
            border: 1px solid rgba(0, 255, 242, 0.1);
            margin-bottom: 10px;
        }

        .cart-item-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .cart-item-name {
            font-size: 13px;
            line-height: 1.3;
        }

        .cart-item-sku {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .qty-btn {
            width: 26px;
            height: 26px;
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 242, 0.2);
            background: rgba(0, 255, 242, 0.08);
            color: var(--neon-cyan);
            cursor: pointer;
        }

        .cart-item-price {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            color: var(--neon-cyan);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .order-card {
            padding: 12px;
            border-radius: 12px;
            background: rgba(0, 255, 242, 0.04);
            border: 1px solid rgba(0, 255, 242, 0.1);
            margin-bottom: 12px;
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .order-status {
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(191, 0, 255, 0.12);
            color: var(--neon-purple);
            font-size: 11px;
            border: 1px solid rgba(191, 0, 255, 0.35);
        }

        .order-status.status-new {
            background: rgba(0, 255, 242, 0.12);
            color: var(--neon-cyan);
            border-color: rgba(0, 255, 242, 0.35);
        }

        .order-status.status-progress {
            background: rgba(255, 199, 87, 0.14);
            color: #ffd77a;
            border-color: rgba(255, 199, 87, 0.4);
        }

        .order-status.status-pickup {
            background: rgba(96, 157, 255, 0.15);
            color: #9cc4ff;
            border-color: rgba(96, 157, 255, 0.45);
        }

        .order-status.status-shipped {
            background: rgba(33, 209, 121, 0.16);
            color: #79f1b8;
            border-color: rgba(33, 209, 121, 0.45);
        }

        .order-status.status-done {
            background: rgba(33, 209, 121, 0.16);
            color: #79f1b8;
            border-color: rgba(33, 209, 121, 0.45);
        }

        .order-status.status-cancelled {
            background: rgba(255, 96, 123, 0.14);
            color: #ff9bb0;
            border-color: rgba(255, 96, 123, 0.42);
        }

        .order-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .profile-history-loading {
            display: grid;
            gap: 10px;
            margin-bottom: 12px;
        }

        .history-skeleton {
            height: 64px;
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 242, 0.12);
            background: linear-gradient(
                90deg,
                rgba(0, 255, 242, 0.06) 0%,
                rgba(0, 255, 242, 0.16) 50%,
                rgba(0, 255, 242, 0.06) 100%
            );
            background-size: 220% 100%;
            animation: profileHistoryShimmer 1.1s linear infinite;
        }

        .history-loading-more {
            padding: 10px 0;
            text-align: center;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .profile-load-more {
            width: 100%;
            margin: 8px 0 0;
            display: none;
        }

        .profile-error {
            display: block;
            color: #ff9494;
            font-size: 12px;
            text-align: center;
            padding: 10px 0;
        }

        .catalog-loading {
            display: none;
            margin: 14px 20px 0;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 242, 0.16);
            background: rgba(0, 255, 242, 0.05);
            color: var(--text-secondary);
            font-size: 12px;
            text-align: center;
        }

        .catalog-sentinel {
            height: 1px;
            width: 100%;
        }

        @keyframes profileHistoryShimmer {
            from {
                background-position: 0% 0;
            }
            to {
                background-position: 220% 0;
            }
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 23, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        .loading-card {
            padding: 16px 22px;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid rgba(0, 255, 242, 0.2);
            color: var(--neon-cyan);
            font-size: 14px;
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: 24px;
            transform: translate(-50%, 20px);
            padding: 10px 16px;
            border-radius: 999px;
            background: var(--bg-card);
            border: 1px solid rgba(0, 255, 242, 0.2);
            color: var(--text-primary);
            font-size: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 400;
        }

        .toast.show {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        .access-gate {
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 23, 0.92);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 450;
        }

        .access-gate.show {
            display: flex;
        }

        .access-gate-card {
            width: 100%;
            max-width: 420px;
            background: #151922;
            border: 1px solid rgba(0, 255, 242, 0.3);
            border-radius: 14px;
            padding: 20px 18px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
        }

        .access-gate-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            margin-bottom: 10px;
            color: var(--neon-cyan);
        }

        .access-gate-text {
            color: var(--text-primary);
            font-size: 14px;
            line-height: 1.45;
        }

        body.app-locked .search-row,
        body.app-locked .status-row,
        body.app-locked .breadcrumb,
        body.app-locked main,
        body.app-locked .header-actions {
            pointer-events: none;
            user-select: none;
            opacity: 0.45;
            filter: blur(1px);
        }

        @media (max-width: 720px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        @media (max-width: 560px) {
            .logo {
                font-size: 20px;
                letter-spacing: 2px;
            }

            .header-action-btn {
                width: 36px;
                height: 36px;
            }

            .btn-categories {
                padding: 0 10px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="brand-row">
            <div class="logo">DIXEL</div>
            <div class="header-actions">
                <button class="header-action-btn" id="profileButton" type="button" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">üë§</button>
                <button class="header-action-btn header-cart-btn" id="cartButton" type="button" aria-label="–ö–æ—Ä–∑–∏–Ω–∞">
                    <span aria-hidden="true">üõí</span>
                    <span class="header-cart-count" id="cartBadge">0</span>
                </button>
            </div>
        </div>

        <div class="search-row">
            <button class="btn-categories" id="openCategories" type="button">‚ò∞ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
            <div class="search-bar">
                <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∞—Ä—Ç–∏–∫—É–ª—É, –Ω–∞–∑–≤–∞–Ω–∏—é...">
                <span class="search-icon">‚ö°</span>
            </div>
        </div>
    </header>

    <div class="breadcrumb" id="breadcrumb"></div>
    <div class="status-row">
        <div class="status-pill" id="resultsCount">–¢–æ–≤–∞—Ä–æ–≤: 0</div>
        <div class="status-pill" id="activeFilters">–§–∏–ª—å—Ç—Ä—ã: –Ω–µ—Ç</div>
    </div>

    <div class="access-gate" id="accessGate" aria-live="polite">
        <div class="access-gate-card">
            <div class="access-gate-title">–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</div>
            <div class="access-gate-text" id="accessGateMessage">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞.</div>
        </div>
    </div>

    <main>
        <div class="products-grid" id="productsGrid"></div>
        <div class="empty-state" id="emptyState">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º.</div>
        <div class="catalog-loading" id="catalogLoading">–ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã...</div>
        <div class="catalog-loading" id="catalogLoadingMore">–ó–∞–≥—Ä—É–∂–∞–µ–º –µ—â—ë —Ç–æ–≤–∞—Ä—ã...</div>
        <div class="catalog-sentinel" id="catalogSentinel" aria-hidden="true"></div>
    </main>

    <div class="drawer drawer-left" id="categoryDrawer">
        <div class="drawer-panel">
            <div class="drawer-header">
                <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                <button class="icon-btn" data-close="categoryDrawer" type="button">‚úï</button>
            </div>
            <div class="drawer-body" id="categoryTree"></div>
        </div>
    </div>

    <div class="drawer" id="cartDrawer">
        <div class="drawer-panel">
            <div class="drawer-header">
                <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
                <button class="icon-btn" data-close="cartDrawer" type="button">‚úï</button>
            </div>
            <div class="drawer-body" id="cartItems"></div>
            <div class="drawer-footer">
                <div class="summary-row">
                    <span>–ò—Ç–æ–≥–æ</span>
                    <span id="cartTotal">0 ‚ÇΩ</span>
                </div>
                <button class="btn btn-cart" id="orderButton" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–∫–∞–∑</button>
            </div>
        </div>
    </div>

    <div class="drawer" id="profileDrawer">
        <div class="drawer-panel">
            <div class="drawer-header">
                <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
                <button class="icon-btn" data-close="profileDrawer" type="button">‚úï</button>
            </div>
            <div class="drawer-body">
                <div class="profile-card">
                    <div class="profile-label">Telegram –∞–∫–∫–∞—É–Ω—Ç</div>
                    <div class="profile-value" id="profileTelegram">‚Äî</div>
                </div>
                <div class="profile-section-title">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
                <div id="profileHistory"></div>
                <button class="btn btn-load profile-load-more" id="profileLoadMore" type="button">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë 5</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <template id="productTemplate">
        <div class="product-card">
            <div class="product-image">
                <img src="" alt="">
            </div>
            <div class="product-sku"></div>
            <div class="product-name"></div>
            <div class="product-footer">
                <div class="product-price-block">
                    <div class="product-price"></div>
                </div>
                <div class="product-stock"></div>
            </div>
            <button class="add-to-cart" type="button">–í –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
    </template>

    <script>
        const PLACEHOLDER_IMAGE = "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=";
        const EMPTY_PICTURE_RE = /^(null|undefined|none|n\/a)$/i;
        const PROFILE_PAGE_SIZE = 5;
        const CATALOG_PAGE_SIZE = 24;
        const PRICING_REQUEST_CHUNK = 200;
        const NON_TEXT_INPUT_TYPES = new Set([
            "button",
            "checkbox",
            "color",
            "file",
            "hidden",
            "image",
            "radio",
            "range",
            "reset",
            "submit"
        ]);

        const STORAGE_KEYS = {
            cart: "dixel_cart",
            user: "dixel_user"
        };

        function normalizePictureUrl(value) {
            if (value == null) {
                return null;
            }
            const raw = String(value).trim();
            if (!raw || EMPTY_PICTURE_RE.test(raw)) {
                return null;
            }
            return raw;
        }

        const state = {
            categoriesById: {},
            roots: [],
            categoryDescendants: {},
            expandedCategories: new Set(),
            selectedCategoryId: null,
            products: [],
            productsById: {},
            filteredProducts: [],
            loadedProductIds: new Set(),
            searchQuery: "",
            pricesById: {},
            pricingEnabled: false,
            pricingBlocked: false,
            pricedProductIds: new Set(),
            pricingPendingIds: new Set(),
            cart: [],
            categoriesLoaded: false,
            catalogOffset: 0,
            catalogHasMore: true,
            catalogLoading: false,
            catalogLoadingMore: false,
            catalogLoaded: false,
            catalogRequestId: 0,
            catalogObserver: null,
            profileOrders: [],
            profileOrdersOffset: 0,
            profileOrdersHasMore: false,
            profileOrdersLoading: false,
            profileOrdersLoadingMore: false,
            profileOrdersLoaded: false,
            profileOrdersError: "",
            profileOrdersRequestId: 0,
            user: null,
            sessionStatus: "unknown"
        };

        const el = {
            searchInput: document.getElementById("searchInput"),
            openCategories: document.getElementById("openCategories"),
            cartButton: document.getElementById("cartButton"),
            cartBadge: document.getElementById("cartBadge"),
            profileButton: document.getElementById("profileButton"),
            profileTelegram: document.getElementById("profileTelegram"),
            breadcrumb: document.getElementById("breadcrumb"),
            resultsCount: document.getElementById("resultsCount"),
            activeFilters: document.getElementById("activeFilters"),
            productsGrid: document.getElementById("productsGrid"),
            emptyState: document.getElementById("emptyState"),
            catalogLoading: document.getElementById("catalogLoading"),
            catalogLoadingMore: document.getElementById("catalogLoadingMore"),
            catalogSentinel: document.getElementById("catalogSentinel"),
            categoryDrawer: document.getElementById("categoryDrawer"),
            categoryTree: document.getElementById("categoryTree"),
            cartDrawer: document.getElementById("cartDrawer"),
            cartItems: document.getElementById("cartItems"),
            cartTotal: document.getElementById("cartTotal"),
            orderButton: document.getElementById("orderButton"),
            profileDrawer: document.getElementById("profileDrawer"),
            profileHistory: document.getElementById("profileHistory"),
            profileLoadMore: document.getElementById("profileLoadMore"),
            accessGate: document.getElementById("accessGate"),
            accessGateMessage: document.getElementById("accessGateMessage"),
            toast: document.getElementById("toast")
        };

        const productTemplate = document.getElementById("productTemplate");
        const currencyFormatter = new Intl.NumberFormat("ru-RU", { maximumFractionDigits: 0 });

        init();

        async function init() {
            bindUI();
            initCatalogObserver();
            loadStoredState();
            initTelegram();
            renderProfile();
            renderCategoryTree();
            renderBreadcrumb();
            renderProducts();
            updateStatus();
            await syncSessionStatus();
            applySessionGate();
            if (isSessionActive()) {
                await applyFilters({ withCategories: true });
            }
            renderHistory();
            updateCartBadge();
        }

        function initCatalogObserver() {
            if (!el.catalogSentinel || typeof IntersectionObserver !== "function") {
                return;
            }
            if (state.catalogObserver) {
                state.catalogObserver.disconnect();
            }
            state.catalogObserver = new IntersectionObserver((entries) => {
                entries.forEach((entry) => {
                    if (!entry.isIntersecting) {
                        return;
                    }
                    loadCatalogPage();
                });
            }, {
                root: null,
                rootMargin: "260px 0px",
                threshold: 0.01
            });
            state.catalogObserver.observe(el.catalogSentinel);
        }

        function bindUI() {
            let searchTimer;
            el.searchInput.addEventListener("input", (event) => {
                if (!isSessionActive()) {
                    event.target.value = "";
                    return;
                }
                clearTimeout(searchTimer);
                const value = event.target.value;
                searchTimer = setTimeout(() => {
                    state.searchQuery = value.trim().toLowerCase();
                    applyFilters();
                }, 150);
            });
            bindKeyboardDismiss();

            el.openCategories.addEventListener("click", () => {
                if (!ensureActiveSession()) {
                    return;
                }
                openDrawer("categoryDrawer");
            });
            el.cartButton.addEventListener("click", () => {
                if (!ensureActiveSession()) {
                    return;
                }
                renderCart();
                openDrawer("cartDrawer");
            });
            el.profileButton.addEventListener("click", () => {
                if (!ensureActiveSession()) {
                    return;
                }
                renderProfile();
                openDrawer("profileDrawer");
                loadProfileOrders({ reset: true });
            });
            el.orderButton.addEventListener("click", placeOrder);
            el.profileLoadMore.addEventListener("click", () => {
                loadProfileOrders();
            });

            document.querySelectorAll(".drawer").forEach((drawer) => {
                drawer.addEventListener("click", (event) => {
                    if (event.target === drawer) {
                        closeDrawer(drawer.id);
                    }
                });
            });

            document.querySelectorAll("[data-close]").forEach((btn) => {
                btn.addEventListener("click", () => closeDrawer(btn.dataset.close));
            });
        }

        function bindKeyboardDismiss() {
            const handler = (event) => dismissKeyboardOnOutsideTap(event);
            document.addEventListener("touchstart", handler, { passive: true });
            document.addEventListener("pointerdown", handler);
        }

        function dismissKeyboardOnOutsideTap(event) {
            const activeElement = document.activeElement;
            if (!isTextEntryElement(activeElement)) {
                return;
            }

            const target = event.target;
            if (!(target instanceof Element)) {
                dismissActiveTextEntry();
                return;
            }

            if (target === activeElement || activeElement.contains(target)) {
                return;
            }

            if (target.closest("input, textarea, [contenteditable='true']")) {
                return;
            }

            if (target.closest(".search-bar")) {
                return;
            }

            dismissActiveTextEntry();
        }

        function dismissActiveTextEntry() {
            const activeElement = document.activeElement;
            if (!isTextEntryElement(activeElement)) {
                return;
            }
            activeElement.blur();
        }

        function isTextEntryElement(node) {
            if (!(node instanceof HTMLElement)) {
                return false;
            }
            if (node instanceof HTMLTextAreaElement) {
                return true;
            }
            if (node instanceof HTMLInputElement) {
                return !NON_TEXT_INPUT_TYPES.has(node.type);
            }
            return node.isContentEditable;
        }

        function loadStoredState() {
            state.cart = safeParse(localStorage.getItem(STORAGE_KEYS.cart), []);
            const savedUser = safeParse(localStorage.getItem(STORAGE_KEYS.user), null);
            if (savedUser) {
                state.user = savedUser;
            }
            localStorage.removeItem("dixel_orders");
            localStorage.removeItem("dixel_price_tier");
            state.pricingEnabled = false;
            state.pricingBlocked = false;
            state.pricesById = {};
            state.pricedProductIds = new Set();
            state.pricingPendingIds = new Set();
            state.categoriesLoaded = false;
            state.loadedProductIds = new Set();
            state.products = [];
            state.filteredProducts = [];
            state.catalogOffset = 0;
            state.catalogHasMore = true;
            state.catalogLoading = false;
            state.catalogLoadingMore = false;
            state.catalogLoaded = false;
            state.catalogRequestId = 0;
            state.sessionStatus = "unknown";
        }

        function initTelegram() {
            const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            console.log("üîç [DEBUG] Telegram WebApp:", tg ? "–¥–æ—Å—Ç—É–ø–µ–Ω" : "–ù–ï –¥–æ—Å—Ç—É–ø–µ–Ω");
            if (tg) {
                tg.ready();
                tg.expand();
                console.log("üîç [DEBUG] initData:", tg.initData ? "–µ—Å—Ç—å" : "–ù–ï–¢");
            }
            const tgUser = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;
            console.log("üîç [DEBUG] Telegram User:", tgUser);
            if (tgUser) {
                const fullName = [tgUser.first_name, tgUser.last_name].filter(Boolean).join(" ");
                state.user = {
                    id: tgUser.id,
                    name: fullName || tgUser.username || `ID ${tgUser.id}`,
                    username: tgUser.username || null
                };
                console.log("‚úÖ [DEBUG] User —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:", state.user);
                saveUser();
            }
        }

        function isSessionActive() {
            return state.sessionStatus === "active";
        }

        function getSessionBlockMessage(status) {
            if (status === "pending") {
                return "–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞. –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞.";
            }
            if (status === "blocked") {
                return "–î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É.";
            }
            if (status === "unauthorized") {
                return "–°–µ—Å—Å–∏—è Telegram –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –û—Ç–∫—Ä–æ–π—Ç–µ mini app —á–µ—Ä–µ–∑ –±–æ—Ç–∞.";
            }
            return "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞.";
        }

        function applySessionGate() {
            const active = isSessionActive();
            if (el.accessGateMessage) {
                el.accessGateMessage.textContent = active
                    ? ""
                    : getSessionBlockMessage(state.sessionStatus);
            }
            if (el.accessGate) {
                el.accessGate.classList.toggle("show", !active);
            }
            document.body.classList.toggle("app-locked", !active);
            if (!active) {
                document.querySelectorAll(".drawer.open").forEach((drawer) => {
                    drawer.classList.remove("open");
                });
            }
            updateStatus();
        }

        function ensureActiveSession() {
            if (isSessionActive()) {
                return true;
            }
            showToast(getSessionBlockMessage(state.sessionStatus));
            return false;
        }

        function mapSessionStatusFromApiError(code) {
            if (code === "registration_pending") {
                return "pending";
            }
            if (code === "customer_blocked") {
                return "blocked";
            }
            if (code === "registration_required" || code === "customer_not_found") {
                return "not_registered";
            }
            if (code === "unauthorized") {
                return "unauthorized";
            }
            return null;
        }

        async function syncSessionStatus() {
            const initData = getTelegramInitData();
            if (!initData) {
                state.sessionStatus = "unauthorized";
                return state.sessionStatus;
            }

            try {
                const response = await fetch("/api/session/status", {
                    method: "GET",
                    headers: {
                        "x-telegram-init-data": initData
                    },
                    cache: "no-store"
                });

                const payload = await response.json().catch(() => null);
                if (response.status === 401) {
                    state.sessionStatus = "unauthorized";
                    return state.sessionStatus;
                }
                if (!response.ok) {
                    state.sessionStatus = "not_registered";
                    return state.sessionStatus;
                }

                const status = String(payload?.status || "").trim();
                if (status === "active" || status === "pending" || status === "not_registered" || status === "blocked") {
                    state.sessionStatus = status;
                } else {
                    state.sessionStatus = "not_registered";
                }
                return state.sessionStatus;
            } catch (error) {
                console.error("‚ùå [SESSION] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å:", error);
                state.sessionStatus = "not_registered";
                return state.sessionStatus;
            }
        }

        function canShowPrices() {
            return isSessionActive() && state.pricingEnabled;
        }

        function renderProfile() {
            if (!el.profileTelegram) {
                return;
            }
            if (!state.user) {
                el.profileTelegram.textContent = "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω";
                return;
            }
            const handle = state.user.username ? `@${state.user.username}` : "";
            el.profileTelegram.textContent = handle || state.user.name || `ID ${state.user.id}`;
        }

        function getTelegramInitData() {
            const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            return tg ? String(tg.initData || "") : "";
        }

        function splitIntoChunks(items, chunkSize) {
            const chunks = [];
            for (let i = 0; i < items.length; i += chunkSize) {
                chunks.push(items.slice(i, i + chunkSize));
            }
            return chunks;
        }

        async function fetchPricingForIds(productIds) {
            if (state.pricingBlocked) {
                return;
            }

            if (!isSessionActive()) {
                state.pricingEnabled = false;
                state.pricingBlocked = true;
                state.pricesById = {};
                return;
            }

            const initData = getTelegramInitData();
            if (!initData) {
                state.pricingEnabled = false;
                state.pricingBlocked = true;
                state.pricesById = {};
                state.sessionStatus = "unauthorized";
                applySessionGate();
                renderProducts();
                renderCart();
                updateCartBadge();
                return;
            }

            const ids = Array.from(
                new Set(
                    (Array.isArray(productIds) ? productIds : [])
                        .map((value) => String(value || "").trim())
                        .filter(Boolean)
                )
            ).filter((id) => !state.pricedProductIds.has(id) && !state.pricingPendingIds.has(id));

            if (!ids.length) {
                return;
            }

            ids.forEach((id) => state.pricingPendingIds.add(id));

            try {
                const priceChunks = splitIntoChunks(ids, PRICING_REQUEST_CHUNK);
                const nextPrices = {};
                let isAuthorized = true;

                for (const idsChunk of priceChunks) {
                    const response = await fetch("/api/pricing", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ initData, productIds: idsChunk })
                    });

                    if (!response.ok) {
                        throw new Error("Pricing fetch failed");
                    }

                    const payload = await response.json();
                    if (!payload?.authorized) {
                        const statusFromApi = mapSessionStatusFromApiError(payload?.reason);
                        if (statusFromApi) {
                            state.sessionStatus = statusFromApi;
                            applySessionGate();
                        }
                        isAuthorized = false;
                        break;
                    }

                    const prices = payload.prices || {};
                    Object.keys(prices).forEach((key) => {
                        const value = Number.parseFloat(prices[key]);
                        if (Number.isFinite(value)) {
                            nextPrices[key] = value;
                        }
                    });
                }

                if (!isAuthorized) {
                    state.pricingEnabled = false;
                    state.pricingBlocked = true;
                    state.pricesById = {};
                    state.pricedProductIds = new Set();
                    return;
                }

                state.pricingEnabled = true;
                state.pricesById = {
                    ...state.pricesById,
                    ...nextPrices
                };
                ids.forEach((id) => state.pricedProductIds.add(id));
            } catch (error) {
                console.error(error);
            } finally {
                ids.forEach((id) => state.pricingPendingIds.delete(id));
                renderProducts();
                renderCart();
                updateCartBadge();
            }
        }

        function buildCatalogRequestUrl({ offset = 0, withCategories = false } = {}) {
            const params = new URLSearchParams();
            params.set("limit", String(CATALOG_PAGE_SIZE));
            params.set("offset", String(Math.max(0, offset)));

            const query = state.searchQuery.trim();
            if (query) {
                params.set("q", query);
            }

            if (state.selectedCategoryId) {
                const categoryIds = Array.from(getCategorySet(state.selectedCategoryId));
                if (categoryIds.length) {
                    params.set("categoryIds", categoryIds.join(","));
                }
            }

            if (withCategories) {
                params.set("withCategories", "1");
            }

            return `/api/catalog?${params.toString()}`;
        }

        function normalizeCatalogProducts(rawProducts) {
            return (Array.isArray(rawProducts) ? rawProducts : [])
                .map((item) => {
                    const id = item?.id ? String(item.id) : "";
                    const name = item?.name ? String(item.name).trim() : "";
                    if (!id || !name) {
                        return null;
                    }
                    const sku = item?.sku ? String(item.sku) : id;
                    const categoryId = item?.categoryId ? String(item.categoryId) : null;
                    const picture = normalizePictureUrl(item?.picture);
                    const stockValue = Number.parseFloat(item?.stock);
                    const stock = Number.isFinite(stockValue) ? Math.round(stockValue) : 0;
                    const available = typeof item?.available === "boolean" ? item.available : stock > 0;

                    return {
                        id,
                        sku,
                        name,
                        categoryId,
                        picture,
                        available,
                        stock,
                        searchText: `${sku} ${name}`.toLowerCase()
                    };
                })
                .filter(Boolean)
                .filter((product) => product.stock > 0);
        }

        function applyCatalogCategories(payload) {
            const categories = Array.isArray(payload?.categories) ? payload.categories : [];
            const categoriesById = {};

            categories.forEach((node) => {
                const id = node?.id ? String(node.id) : "";
                const parentId = node?.parentId ? String(node.parentId) : null;
                const name = node?.name ? String(node.name).trim() : "";
                if (!id || !name) {
                    return;
                }
                categoriesById[id] = {
                    id,
                    parentId: parentId || null,
                    name,
                    children: []
                };
            });

            const roots = [];
            Object.values(categoriesById).forEach((category) => {
                if (category.parentId && categoriesById[category.parentId]) {
                    categoriesById[category.parentId].children.push(category);
                } else {
                    roots.push(category);
                }
            });

            const sortCategories = (list) => {
                list.sort((a, b) => a.name.localeCompare(b.name, "ru"));
                list.forEach((item) => sortCategories(item.children));
            };
            sortCategories(roots);

            state.categoriesById = categoriesById;
            state.roots = roots;
            state.categoryDescendants = {};
            state.expandedCategories = new Set();
            state.categoriesLoaded = true;
        }

        async function loadCatalogPage({ reset = false, withCategories = false } = {}) {
            if (!isSessionActive()) {
                state.catalogLoading = false;
                state.catalogLoadingMore = false;
                state.catalogLoaded = true;
                renderCatalogLoadingState();
                return;
            }

            if (!reset && (state.catalogLoading || !state.catalogHasMore)) {
                return;
            }

            const requestId = state.catalogRequestId + 1;
            state.catalogRequestId = requestId;

            if (reset) {
                state.catalogOffset = 0;
                state.catalogHasMore = true;
                state.catalogLoaded = false;
                state.products = [];
                state.filteredProducts = [];
                state.loadedProductIds = new Set();
                renderProducts();
                updateStatus();
            }

            const offset = reset ? 0 : state.catalogOffset;
            const requestWithCategories = withCategories || !state.categoriesLoaded;

            state.catalogLoading = true;
            state.catalogLoadingMore = state.catalogLoaded && !reset;
            renderCatalogLoadingState();

            try {
                const initData = getTelegramInitData();
                const response = await fetch(
                    buildCatalogRequestUrl({
                        offset,
                        withCategories: requestWithCategories
                    }),
                    {
                        cache: "no-store",
                        headers: initData
                            ? { "x-telegram-init-data": initData }
                            : {}
                    }
                );

                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => null);
                    const nextStatus = mapSessionStatusFromApiError(errorPayload?.error);
                    if (nextStatus) {
                        state.sessionStatus = nextStatus;
                        applySessionGate();
                    }
                    if (response.status === 401) {
                        state.sessionStatus = "unauthorized";
                        applySessionGate();
                    }
                    throw new Error(errorPayload?.error || "catalog_fetch_failed");
                }

                const payload = await response.json();
                if (requestId !== state.catalogRequestId) {
                    return;
                }

                if (requestWithCategories && Array.isArray(payload?.categories)) {
                    applyCatalogCategories(payload);
                    renderCategoryTree();
                    renderBreadcrumb();
                }

                const normalized = normalizeCatalogProducts(payload?.products);
                const appended = [];

                normalized.forEach((product) => {
                    state.productsById[product.id] = product;
                    if (state.loadedProductIds.has(product.id)) {
                        return;
                    }
                    state.loadedProductIds.add(product.id);
                    appended.push(product);
                });

                state.products = reset
                    ? appended
                    : state.products.concat(appended);
                state.filteredProducts = state.products.slice();

                const nextOffsetValue = Number.parseInt(
                    String(payload?.pagination?.nextOffset || ""),
                    10
                );
                state.catalogOffset = Number.isFinite(nextOffsetValue)
                    ? nextOffsetValue
                    : offset + normalized.length;
                state.catalogHasMore = Boolean(payload?.pagination?.hasMore);
                state.catalogLoaded = true;

                renderProducts();
                updateStatus();
                fetchPricingForIds(appended.map((product) => product.id));
            } catch (error) {
                if (requestId !== state.catalogRequestId) {
                    return;
                }
                console.error(error);
                showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä.");
            } finally {
                if (requestId !== state.catalogRequestId) {
                    return;
                }
                state.catalogLoading = false;
                state.catalogLoadingMore = false;
                state.catalogLoaded = true;
                renderCatalogLoadingState();
                renderProducts();
                updateStatus();
            }
        }

        async function applyFilters({ withCategories = false } = {}) {
            await loadCatalogPage({
                reset: true,
                withCategories: withCategories || !state.categoriesLoaded
            });
        }

        function renderBreadcrumb() {
            el.breadcrumb.innerHTML = "";
            const rootButton = document.createElement("button");
            rootButton.textContent = "–í—Å–µ —Ç–æ–≤–∞—Ä—ã";
            rootButton.addEventListener("click", () => selectCategory(null));
            el.breadcrumb.appendChild(rootButton);

            if (!state.selectedCategoryId) {
                return;
            }

            const path = getCategoryPath(state.selectedCategoryId);
            path.forEach((category) => {
                const divider = document.createElement("span");
                divider.className = "breadcrumb-divider";
                divider.textContent = "‚Ä∫";
                const button = document.createElement("button");
                button.textContent = category.name;
                button.addEventListener("click", () => selectCategory(category.id));
                el.breadcrumb.appendChild(divider);
                el.breadcrumb.appendChild(button);
            });
        }

        function renderCategoryTree() {
            el.categoryTree.innerHTML = "";
            const fragment = document.createDocumentFragment();

            const allWrapper = document.createElement("div");
            allWrapper.className = "category-item";
            const allRow = document.createElement("div");
            allRow.className = `category-row${!state.selectedCategoryId ? " active" : ""}`;
            allRow.style.setProperty("--level", 0);
            const allToggle = document.createElement("button");
            allToggle.className = "category-toggle";
            allToggle.disabled = true;
            const allName = document.createElement("div");
            allName.className = "category-name";
            allName.textContent = "–í—Å–µ —Ç–æ–≤–∞—Ä—ã";
            allRow.appendChild(allToggle);
            allRow.appendChild(allName);
            allRow.addEventListener("click", () => {
                selectCategory(null);
                closeDrawer("categoryDrawer");
            });
            allWrapper.appendChild(allRow);
            fragment.appendChild(allWrapper);

            state.roots.forEach((category) => {
                fragment.appendChild(renderCategoryItem(category, 0));
            });

            el.categoryTree.appendChild(fragment);
        }

        function renderCategoryItem(category, level) {
            const wrapper = document.createElement("div");
            wrapper.className = "category-item";

            const row = document.createElement("div");
            row.className = `category-row${category.id === state.selectedCategoryId ? " active" : ""}`;
            row.style.setProperty("--level", level);

            const toggle = document.createElement("button");
            toggle.className = "category-toggle";
            if (category.children.length) {
                toggle.textContent = state.expandedCategories.has(category.id) ? "‚àí" : "+";
            } else {
                toggle.textContent = "";
                toggle.disabled = true;
            }

            toggle.addEventListener("click", (event) => {
                event.stopPropagation();
                if (!category.children.length) {
                    return;
                }
                if (state.expandedCategories.has(category.id)) {
                    state.expandedCategories.delete(category.id);
                } else {
                    state.expandedCategories.add(category.id);
                }
                renderCategoryTree();
            });

            const name = document.createElement("div");
            name.className = "category-name";
            name.textContent = category.name;

            row.appendChild(toggle);
            row.appendChild(name);

            row.addEventListener("click", () => {
                selectCategory(category.id);
                closeDrawer("categoryDrawer");
            });

            wrapper.appendChild(row);

            if (category.children.length && state.expandedCategories.has(category.id)) {
                const childrenWrapper = document.createElement("div");
                childrenWrapper.className = "category-children";
                category.children.forEach((child) => {
                    childrenWrapper.appendChild(renderCategoryItem(child, level + 1));
                });
                wrapper.appendChild(childrenWrapper);
            }

            return wrapper;
        }

        function renderCatalogLoadingState() {
            if (el.catalogLoading) {
                const showInitialLoading = state.catalogLoading && !state.catalogLoaded;
                el.catalogLoading.style.display = showInitialLoading ? "block" : "none";
            }
            if (el.catalogLoadingMore) {
                const showLoadingMore = state.catalogLoading && state.catalogLoaded && state.catalogLoadingMore;
                el.catalogLoadingMore.style.display = showLoadingMore ? "block" : "none";
            }
            if (el.catalogSentinel) {
                el.catalogSentinel.style.display = state.catalogHasMore ? "block" : "none";
            }
        }

        function renderProducts() {
            el.productsGrid.innerHTML = "";
            const fragment = document.createDocumentFragment();
            const visible = state.filteredProducts;
            visible.forEach((product) => {
                fragment.appendChild(renderProductCard(product));
            });
            el.productsGrid.appendChild(fragment);

            const showEmpty = state.catalogLoaded && !state.catalogLoading && !visible.length;
            el.emptyState.style.display = showEmpty ? "block" : "none";
            renderCatalogLoadingState();
        }

        function renderProductCard(product) {
            const card = productTemplate.content.firstElementChild.cloneNode(true);
            const img = card.querySelector(".product-image img");
            const imageWrap = img.closest(".product-image");
            const picture = normalizePictureUrl(product.picture);
            img.src = picture || PLACEHOLDER_IMAGE;
            img.alt = product.name;
            img.loading = "lazy";
            img.decoding = "async";
            imageWrap.classList.toggle("is-placeholder", !picture);
            img.onerror = () => {
                if (img.src !== PLACEHOLDER_IMAGE) {
                    img.src = PLACEHOLDER_IMAGE;
                }
                imageWrap.classList.add("is-placeholder");
            };

            card.querySelector(".product-sku").textContent = product.sku;
            card.querySelector(".product-name").textContent = product.name;

            const priceEl = card.querySelector(".product-price");
            const pricesVisible = canShowPrices();
            const priceValue = pricesVisible ? getProductPrice(product.id) : null;
            const showPrice = pricesVisible && Number.isFinite(priceValue);
            priceEl.textContent = showPrice ? formatPrice(priceValue) : "‚Äî";
            priceEl.classList.toggle("muted", !showPrice);

            const stock = card.querySelector(".product-stock");
            const addButton = card.querySelector(".add-to-cart");
            if (!showPrice) {
                addButton.disabled = true;
            }
            if (!product.available || product.stock <= 0) {
                stock.textContent = "–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏";
                stock.classList.add("low");
                addButton.disabled = true;
                card.classList.add("disabled");
            } else {
                stock.textContent = `${product.stock} —à—Ç`;
                if (product.stock <= 2) {
                    stock.classList.add("low");
                }
            }

            addButton.addEventListener("click", (event) => {
                event.stopPropagation();
                addToCart(product.id);
            });

            return card;
        }

        function selectCategory(categoryId) {
            if (!isSessionActive()) {
                return;
            }
            state.selectedCategoryId = categoryId;
            if (categoryId) {
                expandCategoryPath(categoryId);
            }
            renderBreadcrumb();
            renderCategoryTree();
            applyFilters();
        }

        function expandCategoryPath(categoryId) {
            let current = state.categoriesById[categoryId];
            while (current) {
                state.expandedCategories.add(current.id);
                current = current.parentId ? state.categoriesById[current.parentId] : null;
            }
        }

        function getCategorySet(categoryId) {
            if (!categoryId) {
                return null;
            }
            if (state.categoryDescendants[categoryId]) {
                return state.categoryDescendants[categoryId];
            }
            const set = new Set();
            const stack = [categoryId];
            while (stack.length) {
                const currentId = stack.pop();
                if (!currentId || set.has(currentId)) {
                    continue;
                }
                set.add(currentId);
                const children = state.categoriesById[currentId]?.children || [];
                children.forEach((child) => stack.push(child.id));
            }
            state.categoryDescendants[categoryId] = set;
            return set;
        }

        function getCategoryPath(categoryId) {
            const path = [];
            let current = state.categoriesById[categoryId];
            while (current) {
                path.unshift(current);
                current = current.parentId ? state.categoriesById[current.parentId] : null;
            }
            return path;
        }

        function updateStatus() {
            if (!isSessionActive()) {
                el.resultsCount.textContent = "–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω";
                el.activeFilters.textContent = getSessionBlockMessage(state.sessionStatus);
                return;
            }
            const suffix = state.catalogHasMore ? "+" : "";
            el.resultsCount.textContent = `–¢–æ–≤–∞—Ä–æ–≤: ${state.filteredProducts.length}${suffix}`;
            const filters = [];
            if (state.selectedCategoryId) {
                const path = getCategoryPath(state.selectedCategoryId);
                if (path.length) {
                    filters.push(`–∫–∞—Ç–µ–≥–æ—Ä–∏—è: ${shorten(path[path.length - 1].name, 24)}`);
                }
            }
            if (state.searchQuery) {
                filters.push(`–ø–æ–∏—Å–∫: ${shorten(state.searchQuery, 24)}`);
            }
            el.activeFilters.textContent = filters.length ? `–§–∏–ª—å—Ç—Ä—ã: ${filters.join(", ")}` : "–§–∏–ª—å—Ç—Ä—ã: –Ω–µ—Ç";
        }

        function addToCart(productId) {
            if (!isSessionActive()) {
                showToast(getSessionBlockMessage(state.sessionStatus));
                return;
            }
            if (!canShowPrices()) {
                showToast("–¶–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
                return;
            }
            const product = state.productsById[productId];
            if (!product || !product.available || product.stock <= 0) {
                return;
            }
            if (!Number.isFinite(getProductPrice(product.id))) {
                showToast("–¶–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
                return;
            }
            const existing = state.cart.find((item) => item.productId === productId);
            if (existing) {
                existing.qty += 1;
            } else {
                state.cart.push({ productId, qty: 1 });
            }
            saveCart();
            updateCartBadge();
            showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É");
        }

        function renderCart() {
            el.cartItems.innerHTML = "";
            if (!isSessionActive()) {
                el.cartItems.innerHTML = `<div class="empty-state" style="display:block">${getSessionBlockMessage(state.sessionStatus)}</div>`;
                el.cartTotal.textContent = formatPrice(null);
                return;
            }
            if (!canShowPrices()) {
                el.cartItems.innerHTML = '<div class="empty-state" style="display:block">–¶–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.</div>';
                el.cartTotal.textContent = formatPrice(null);
                return;
            }
            if (!state.cart.length) {
                el.cartItems.innerHTML = '<div class="empty-state" style="display:block">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</div>';
                el.cartTotal.textContent = formatPrice(0);
                return;
            }

            const fragment = document.createDocumentFragment();
            state.cart.forEach((item) => {
                const product = state.productsById[item.productId];
                if (!product) {
                    return;
                }

                const row = document.createElement("div");
                row.className = "cart-item";

                const info = document.createElement("div");
                info.className = "cart-item-info";
                const name = document.createElement("div");
                name.className = "cart-item-name";
                name.textContent = product.name;
                const sku = document.createElement("div");
                sku.className = "cart-item-sku";
                sku.textContent = product.sku;
                info.appendChild(name);
                info.appendChild(sku);

                const controls = document.createElement("div");
                controls.className = "cart-item-controls";
                const minus = document.createElement("button");
                minus.className = "qty-btn";
                minus.type = "button";
                minus.textContent = "‚àí";
                const qty = document.createElement("span");
                qty.textContent = item.qty;
                const plus = document.createElement("button");
                plus.className = "qty-btn";
                plus.type = "button";
                plus.textContent = "+";

                minus.addEventListener("click", () => updateCartQty(item.productId, item.qty - 1));
                plus.addEventListener("click", () => updateCartQty(item.productId, item.qty + 1));

                controls.appendChild(minus);
                controls.appendChild(qty);
                controls.appendChild(plus);

                const price = document.createElement("div");
                price.className = "cart-item-price";
                const unitPrice = getProductPrice(product.id);
                const lineTotal = Number.isFinite(unitPrice) ? unitPrice * item.qty : null;
                price.textContent = formatPrice(lineTotal);

                row.appendChild(info);
                row.appendChild(controls);
                row.appendChild(price);

                fragment.appendChild(row);
            });

            el.cartItems.appendChild(fragment);
            el.cartTotal.textContent = formatPrice(calculateCartTotal());
        }

        function updateCartQty(productId, qty) {
            const item = state.cart.find((entry) => entry.productId === productId);
            if (!item) {
                return;
            }
            if (qty <= 0) {
                state.cart = state.cart.filter((entry) => entry.productId !== productId);
            } else {
                item.qty = qty;
            }
            saveCart();
            renderCart();
            updateCartBadge();
        }

        function calculateCartTotal() {
            if (!canShowPrices()) {
                return null;
            }
            return state.cart.reduce((sum, item) => {
                const product = state.productsById[item.productId];
                if (!product) {
                    return sum;
                }
                const price = getProductPrice(product.id);
                if (!Number.isFinite(price)) {
                    return sum;
                }
                return sum + price * item.qty;
            }, 0);
        }

        function getCartItemsCount() {
            return state.cart.reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
        }

        function updateCartBadge() {
            const itemsCount = getCartItemsCount();
            if (el.cartBadge) {
                el.cartBadge.textContent = String(itemsCount);
                el.cartBadge.style.display = itemsCount > 0 ? "flex" : "none";
            }
            if (el.cartButton) {
                const cartLabel = itemsCount > 0 ? `–ö–æ—Ä–∑–∏–Ω–∞, —Ç–æ–≤–∞—Ä–æ–≤: ${itemsCount}` : "–ö–æ—Ä–∑–∏–Ω–∞";
                el.cartButton.setAttribute("aria-label", cartLabel);
                el.cartButton.setAttribute("title", cartLabel);
            }
        }

        async function placeOrder() {
            if (!isSessionActive()) {
                showToast(getSessionBlockMessage(state.sessionStatus));
                return;
            }
            if (!canShowPrices()) {
                showToast("–¶–µ–Ω—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏");
                return;
            }
            if (!state.user || !state.user.id) {
                showToast("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.");
                return;
            }
            if (!state.cart.length) {
                showToast("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞");
                return;
            }

            const orderId = createOrderId();
            const createdAt = new Date().toISOString();
            const total = calculateCartTotal();
            if (!Number.isFinite(total)) {
                showToast("–¶–µ–Ω–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞");
                return;
            }
            const items = state.cart.map((item) => {
                const product = state.productsById[item.productId];
                return {
                    productId: item.productId,
                    sku: product?.sku,
                    name: product?.name,
                    qty: item.qty,
                    price: getProductPrice(product?.id)
                };
            });

            const order = {
                id: orderId,
                createdAt,
                total,
                items,
            };

            const result = await sendOrderToTelegram(order);
            if (!result.ok) {
                showToast(result.error || "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.");
                return;
            }

            state.cart = [];
            saveCart();
            renderCart();
            updateCartBadge();
            closeDrawer("cartDrawer");
            showToast("–ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω");

            if (el.profileDrawer.classList.contains("open")) {
                loadProfileOrders({ reset: true });
            }
        }

        function mapOrderStatus(status) {
            const raw = String(status || "").trim();
            const normalized = raw.toLowerCase();
            if (normalized === "–Ω–æ–≤—ã–π") {
                return "–ù–æ–≤—ã–π";
            }
            if (normalized === "–≤ —Ä–∞–±–æ—Ç–µ") {
                return "–í —Ä–∞–±–æ—Ç–µ";
            }
            if (normalized === "—Å–æ–±—Ä–∞–Ω –Ω–∞ –ø–≤–∑") {
                return "–°–æ–±—Ä–∞–Ω –Ω–∞ –ü–í–ó";
            }
            if (normalized === "–æ—Ç–≥—Ä—É–∂–µ–Ω") {
                return "–û—Ç–≥—Ä—É–∂–µ–Ω";
            }
            if (normalized === "pending") {
                return "–í –æ–±—Ä–∞–±–æ—Ç–∫–µ";
            }
            if (normalized === "done") {
                return "–ó–∞–≤–µ—Ä—à–µ–Ω";
            }
            if (normalized === "canceled" || normalized === "cancelled") {
                return "–û—Ç–º–µ–Ω–µ–Ω";
            }
            return raw || "–í –æ–±—Ä–∞–±–æ—Ç–∫–µ";
        }

        function getOrderStatusClass(status) {
            const normalized = String(status || "").trim().toLowerCase();
            if (normalized === "–Ω–æ–≤—ã–π" || normalized === "pending") {
                return "status-new";
            }
            if (normalized === "–≤ —Ä–∞–±–æ—Ç–µ" || normalized === "–≤ —Å–±–æ—Ä–∫–µ" || normalized === "–≤ —Å–±–æ—Ä–∫—É –¥–æ—É–∫–æ–º–ø–ª–µ–∫—Ç–æ–≤–∞—Ç—å") {
                return "status-progress";
            }
            if (normalized === "—Å–æ–±—Ä–∞–Ω –Ω–∞ –ø–≤–∑") {
                return "status-pickup";
            }
            if (normalized === "–æ—Ç–≥—Ä—É–∂–µ–Ω" || normalized === "done") {
                return "status-shipped";
            }
            if (normalized === "canceled" || normalized === "cancelled") {
                return "status-cancelled";
            }
            return "";
        }

        function renderHistory() {
            el.profileHistory.innerHTML = "";
            el.profileLoadMore.style.display = "none";

            if (!state.user || !state.user.id) {
                el.profileHistory.innerHTML = '<div class="empty-state" style="display:block">–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</div>';
                return;
            }

            if (state.profileOrdersLoading && !state.profileOrders.length) {
                el.profileHistory.innerHTML = `
                    <div class="profile-history-loading">
                        <div class="history-skeleton"></div>
                        <div class="history-skeleton"></div>
                        <div class="history-skeleton"></div>
                    </div>
                `;
                return;
            }

            if (state.profileOrdersError && !state.profileOrders.length) {
                el.profileHistory.innerHTML = `<div class="profile-error">${state.profileOrdersError}</div>`;
                return;
            }

            if (!state.profileOrders.length) {
                el.profileHistory.innerHTML = '<div class="empty-state" style="display:block">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤.</div>';
                return;
            }

            const fragment = document.createDocumentFragment();
            state.profileOrders.forEach((order) => {
                const card = document.createElement("div");
                card.className = "order-card";

                const header = document.createElement("div");
                header.className = "order-header";
                const title = document.createElement("div");
                title.textContent = `–ó–∞–∫–∞–∑ ${shortOrderId(order.id)}`;
                const status = document.createElement("span");
                const statusClass = getOrderStatusClass(order.status);
                status.className = statusClass
                    ? `order-status ${statusClass}`
                    : "order-status";
                status.textContent = mapOrderStatus(order.status);
                header.appendChild(title);
                header.appendChild(status);

                const meta = document.createElement("div");
                meta.className = "order-meta";
                const date = order.createdAt
                    ? new Date(order.createdAt).toLocaleString("ru-RU")
                    : "–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞";
                const items = Array.isArray(order.items) ? order.items : [];
                const itemsCount = items.reduce((sum, item) => sum + (item.qty || 0), 0);
                meta.textContent = `${date} ‚Ä¢ ${itemsCount} –ø–æ–∑–∏—Ü–∏–π ‚Ä¢ ${formatPrice(order.total)}`;

                card.appendChild(header);
                card.appendChild(meta);
                fragment.appendChild(card);
            });

            el.profileHistory.appendChild(fragment);

            if (state.profileOrdersLoadingMore) {
                const loadingMore = document.createElement("div");
                loadingMore.className = "history-loading-more";
                loadingMore.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤...";
                el.profileHistory.appendChild(loadingMore);
            }

            if (state.profileOrdersHasMore) {
                el.profileLoadMore.style.display = "block";
                el.profileLoadMore.disabled = Boolean(state.profileOrdersLoadingMore);
                el.profileLoadMore.textContent = state.profileOrdersLoadingMore
                    ? "–ó–∞–≥—Ä—É–∑–∫–∞..."
                    : `–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë ${PROFILE_PAGE_SIZE}`;
            }
        }

        function shortOrderId(orderId) {
            const value = String(orderId || "");
            if (!value) {
                return "‚Äî";
            }
            if (value.length <= 8) {
                return value;
            }
            return `${value.slice(0, 8)}...`;
        }

        async function loadProfileOrders({ reset = false } = {}) {
            if (!isSessionActive()) {
                state.profileOrders = [];
                state.profileOrdersOffset = 0;
                state.profileOrdersHasMore = false;
                state.profileOrdersLoaded = true;
                state.profileOrdersError = getSessionBlockMessage(state.sessionStatus);
                renderHistory();
                return;
            }

            if (!state.user || !state.user.id) {
                state.profileOrders = [];
                state.profileOrdersOffset = 0;
                state.profileOrdersHasMore = false;
                state.profileOrdersLoaded = true;
                state.profileOrdersError = "";
                renderHistory();
                return;
            }

            if (reset) {
                state.profileOrders = [];
                state.profileOrdersOffset = 0;
                state.profileOrdersHasMore = false;
                state.profileOrdersError = "";
                state.profileOrdersLoaded = false;
                state.profileOrdersLoading = true;
                state.profileOrdersLoadingMore = false;
            } else {
                if (!state.profileOrdersLoaded || !state.profileOrdersHasMore || state.profileOrdersLoadingMore) {
                    return;
                }
                state.profileOrdersLoadingMore = true;
                state.profileOrdersError = "";
            }
            renderHistory();

            const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            const initData = tg ? tg.initData : "";
            const requestId = state.profileOrdersRequestId + 1;
            state.profileOrdersRequestId = requestId;
            if (!initData) {
                state.profileOrdersLoading = false;
                state.profileOrdersLoadingMore = false;
                state.profileOrdersLoaded = true;
                state.profileOrdersError = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã: –Ω–µ—Ç Telegram-—Å–µ—Å—Å–∏–∏.";
                renderHistory();
                return;
            }

            try {
                const offset = reset ? 0 : state.profileOrdersOffset;
                const response = await fetch(
                    `/api/orders?limit=${PROFILE_PAGE_SIZE}&offset=${offset}`,
                    {
                        method: "GET",
                        headers: {
                            "x-telegram-init-data": initData
                        },
                        cache: "no-store"
                    }
                );

                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => null);
                    if (response.status === 401) {
                        state.sessionStatus = "unauthorized";
                        applySessionGate();
                        throw new Error("unauthorized");
                    }
                    const statusFromApi = mapSessionStatusFromApiError(errorPayload?.error);
                    if (statusFromApi) {
                        state.sessionStatus = statusFromApi;
                        applySessionGate();
                        throw new Error("access_denied");
                    }
                    throw new Error(errorPayload?.error || `HTTP ${response.status}`);
                }

                const payload = await response.json();
                if (!payload?.ok) {
                    throw new Error(payload?.error || "orders_fetch_failed");
                }

                if (requestId !== state.profileOrdersRequestId) {
                    return;
                }

                const nextOrders = Array.isArray(payload.orders) ? payload.orders : [];
                const mergedOrders = reset
                    ? nextOrders
                    : state.profileOrders.concat(nextOrders);

                state.profileOrders = mergedOrders;
                state.profileOrdersOffset = mergedOrders.length;
                state.profileOrdersHasMore = Boolean(payload?.pagination?.hasMore);
                state.profileOrdersLoaded = true;
                state.profileOrdersError = "";
            } catch (error) {
                if (requestId !== state.profileOrdersRequestId) {
                    return;
                }
                console.error("‚ùå [PROFILE] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã:", error);
                if (String(error?.message || "") === "unauthorized") {
                    state.profileOrdersError = "–°–µ—Å—Å–∏—è Telegram –∏—Å—Ç–µ–∫–ª–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.";
                } else if (String(error?.message || "") === "access_denied") {
                    state.profileOrdersError = getSessionBlockMessage(state.sessionStatus);
                } else {
                    state.profileOrdersError = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–∫–∞–∑—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.";
                }
                showToast("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫–∞–∑–æ–≤");
                if (reset) {
                    state.profileOrders = [];
                    state.profileOrdersOffset = 0;
                    state.profileOrdersHasMore = false;
                }
                state.profileOrdersLoaded = true;
            } finally {
                if (requestId !== state.profileOrdersRequestId) {
                    return;
                }
                state.profileOrdersLoading = false;
                state.profileOrdersLoadingMore = false;
                renderHistory();
            }
        }

        async function sendOrderToTelegram(order) {
            const payload = {
                type: "order",
                orderId: order.id,
                createdAt: order.createdAt,
                total: order.total,
                user: state.user,
                items: order.items
            };

            const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
            const initData = tg ? tg.initData : "";
            if (!initData) {
                return { ok: false, error: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å Telegram-—Å–µ—Å—Å–∏—é." };
            }

            try {
                const response = await fetch("/api/order", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ initData, order: payload })
                });
                if (!response.ok) {
                    const errorPayload = await response.json().catch(() => null);
                    const statusFromApi = mapSessionStatusFromApiError(errorPayload?.error);
                    if (statusFromApi) {
                        state.sessionStatus = statusFromApi;
                        applySessionGate();
                    }
                    if (errorPayload?.error === "customer_not_found") {
                        return { ok: false, error: "–í–∞—à Telegram –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–ª–∏–µ–Ω—Ç—É. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É." };
                    }
                    if (errorPayload?.error === "registration_pending") {
                        return { ok: false, error: "–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ. –û–∂–∏–¥–∞–π—Ç–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞." };
                    }
                    if (errorPayload?.error === "customer_blocked") {
                        return { ok: false, error: "–î–æ—Å—Ç—É–ø –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –º–µ–Ω–µ–¥–∂–µ—Ä—É." };
                    }
                    return { ok: false, error: "–°–µ—Ä–≤–µ—Ä –Ω–µ –ø—Ä–∏–Ω—è–ª –∑–∞–∫–∞–∑. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑." };
                }

                const result = await response.json().catch(() => null);
                if (!result?.ok) {
                    return { ok: false, error: "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–∫–∞–∑ –≤ –±–∞–∑–µ." };
                }
                return { ok: true };
            } catch (error) {
                console.warn("‚ö†Ô∏è [ORDER] /api/order error:", error);
                return { ok: false, error: "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–∫–∞–∑–∞." };
            }
        }

        function openDrawer(id) {
            dismissActiveTextEntry();
            const drawer = document.getElementById(id);
            if (drawer) {
                drawer.classList.add("open");
            }
        }

        function closeDrawer(id) {
            dismissActiveTextEntry();
            const drawer = document.getElementById(id);
            if (drawer) {
                drawer.classList.remove("open");
            }
        }

        function showToast(message) {
            if (!message) {
                return;
            }
            el.toast.textContent = message;
            el.toast.classList.add("show");
            clearTimeout(el.toast._timer);
            el.toast._timer = setTimeout(() => {
                el.toast.classList.remove("show");
            }, 2600);
        }

        function formatPrice(value) {
            if (!Number.isFinite(value)) {
                return "‚Äî";
            }
            return `${currencyFormatter.format(value)} ‚ÇΩ`;
        }

        function getProductPrice(productId) {
            const value = state.pricesById[productId];
            return Number.isFinite(value) ? value : null;
        }

        function createOrderId() {
            const stamp = new Date().toISOString().replace(/[-:T]/g, "").slice(0, 12);
            const rnd = Math.floor(Math.random() * 90 + 10);
            return `DX-${stamp}-${rnd}`;
        }


        function saveCart() {
            localStorage.setItem(STORAGE_KEYS.cart, JSON.stringify(state.cart));
        }

        function saveUser() {
            localStorage.setItem(STORAGE_KEYS.user, JSON.stringify(state.user));
        }

        function safeParse(raw, fallback) {
            if (!raw) {
                return fallback;
            }
            try {
                return JSON.parse(raw) ?? fallback;
            } catch (error) {
                return fallback;
            }
        }

        function shorten(text, maxLength) {
            if (!text || text.length <= maxLength) {
                return text;
            }
            return `${text.slice(0, maxLength)}...`;
        }
    </script>
</body>
</html>
